<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz: Platform Economics Part 1 | Introduction to Digital Finance</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
        :root {
            --mlpurple: #3333B2;
            --mlblue: #0066CC;
            --quiz-accent: #14b8a6;
            --quiz-light: #f0fdfa;
            --correct: #22c55e;
            --correct-bg: #dcfce7;
            --incorrect: #ef4444;
            --incorrect-bg: #fee2e2;
            --bg: #f6f8fa;
            --card-bg: #ffffff;
            --text: #24292e;
            --text-secondary: #586069;
            --border: #e1e4e8;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.4;
            min-height: 100vh;
        }

        .nav {
            background: linear-gradient(135deg, var(--mlpurple), var(--quiz-accent));
            color: white;
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-title { font-weight: 600; font-size: 14px; }
        .nav-links { display: flex; gap: 16px; }
        .nav-links a { color: white; text-decoration: none; font-size: 12px; opacity: 0.9; }
        .nav-links a:hover { opacity: 1; }

        .quiz-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 12px;
        }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 0 4px;
        }
        .quiz-title { font-size: 16px; font-weight: 600; color: var(--mlpurple); }
        .quiz-stats {
            display: flex;
            gap: 12px;
            font-size: 12px;
        }
        .stat-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
        }
        .stat-progress { background: var(--quiz-light); color: var(--quiz-accent); }
        .stat-score { background: var(--correct-bg); color: var(--correct); }

        .progress-bar-container {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin-bottom: 12px;
        }
        .progress-bar {
            height: 100%;
            background: var(--quiz-accent);
            border-radius: 2px;
            transition: width 0.3s;
        }

        /* Three-column layout */
        .questions-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .question-card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 12px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            min-height: 280px;
        }

        .question-card.answered { opacity: 0.7; }

        .question-card.correct-card {
            border: 2px solid var(--correct);
            background: linear-gradient(to bottom, var(--correct-bg), var(--card-bg));
        }

        .question-card.incorrect-card {
            border: 2px solid var(--incorrect);
            background: linear-gradient(to bottom, var(--incorrect-bg), var(--card-bg));
        }

        .q-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .q-number {
            background: var(--quiz-light);
            color: var(--quiz-accent);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        .q-status { font-size: 14px; }

        .q-text {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 10px;
            line-height: 1.4;
            flex-grow: 0;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex-grow: 1;
        }

        .option-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            min-height: 44px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--card-bg);
            cursor: pointer;
            transition: all 0.15s;
            text-align: left;
            font-size: 12px;
        }

        .option-btn:hover:not(.disabled) {
            border-color: var(--quiz-accent);
            background: var(--quiz-light);
        }

        .option-btn.correct {
            border-color: var(--correct);
            background: var(--correct-bg);
        }

        .option-btn.incorrect {
            border-color: var(--incorrect);
            background: var(--incorrect-bg);
        }

        .option-btn.disabled { cursor: default; }

        .option-letter {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 10px;
            flex-shrink: 0;
        }

        .option-btn.correct .option-letter {
            background: var(--correct);
            color: white;
        }

        .option-btn.incorrect .option-letter {
            background: var(--incorrect);
            color: white;
        }

        .option-text { flex: 1; }

        .feedback {
            margin-top: 8px;
            padding: 8px;
            border-radius: 6px;
            font-size: 10px;
            line-height: 1.4;
            display: none;
        }

        .feedback.show { display: block; }
        .feedback.correct { background: var(--correct-bg); color: #166534; }
        .feedback.incorrect { background: var(--incorrect-bg); color: #991b1b; }

        /* Results */
        .results-card {
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 32px;
            text-align: center;
            max-width: 500px;
            margin: 40px auto;
            display: none;
        }
        .results-card.show { display: block; }
        .results-icon { font-size: 48px; margin-bottom: 8px; }
        .results-score { font-size: 36px; font-weight: 700; color: var(--quiz-accent); }
        .results-label { font-size: 14px; color: var(--text-secondary); margin-bottom: 16px; }
        .results-grade {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        .grade-a { background: #dcfce7; color: #166534; }
        .grade-b { background: #dbeafe; color: #1e40af; }
        .grade-c { background: #fef3c7; color: #92400e; }
        .grade-d { background: #fed7aa; color: #9a3412; }
        .grade-f { background: #fee2e2; color: #991b1b; }

        .results-buttons { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            text-decoration: none;
        }
        .btn-primary { background: var(--quiz-accent); color: white; }
        .btn-primary:hover { background: #0d9488; }
        .btn-secondary { background: var(--card-bg); color: var(--text); border: 1px solid var(--border); }

        /* Next button container */
        .next-btn-container {
            display: flex;
            justify-content: center;
            margin-top: 16px;
        }
        .btn-next {
            padding: 10px 32px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            background: var(--quiz-accent);
            color: white;
            transition: all 0.2s;
            display: none;
        }
        .btn-next:hover { background: #0d9488; transform: scale(1.02); }
        .btn-next.show { display: inline-block; }
        .btn-next:disabled { opacity: 0.5; cursor: not-allowed; }

        @media (max-width: 900px) {
            .questions-row { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 600px) {
            .questions-row { grid-template-columns: 1fr; }
            .question-card { min-height: auto; }
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-title">Quiz: Platform Economics -- Part 1: Platforms &amp; Network Effects</div>
        <div class="nav-links">
            <a href="../index.html">Dashboard</a>
            <a href="../lectures/platform_economics.pdf">Lecture PDF</a>
            <a href="https://github.com/Digital-AI-Finance/Digital-Finance-Introduction" target="_blank">GitHub</a>
        </div>
    </nav>

    <main class="quiz-container">
        <div class="quiz-header">
            <div class="quiz-title">Platform Economics Part 1: Platforms &amp; Network Effects (20 Questions)</div>
            <div class="quiz-stats">
                <span class="stat-badge stat-progress" id="progressBadge">0/20</span>
                <span class="stat-badge stat-score" id="scoreBadge">Score: 0</span>
            </div>
        </div>

        <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>

        <div class="questions-row" id="questionsRow"></div>

        <div class="next-btn-container">
            <button class="btn-next" id="nextBtn" onclick="loadNextQuestions()">Next</button>
        </div>

        <div class="results-card" id="resultsCard">
            <div class="results-icon" id="resultsIcon"></div>
            <div class="results-score" id="resultsScore"></div>
            <div class="results-label">Correct Answers</div>
            <div class="results-grade" id="resultsGrade"></div>
            <div class="results-buttons">
                <button class="btn btn-primary" onclick="restartQuiz()">Try Again</button>
                <a href="../index.html" class="btn btn-secondary">Dashboard</a>
            </div>
        </div>
    </main>

    <script>
        const quizData = {
            questions: [
                {
                    "id": 1,
                    "question": "The primary difference between a pipeline and a platform business is:",
                    "options": {
                        "A": "Pipelines use older technology while platforms use modern technology",
                        "B": "Pipelines create value by making/selling; platforms create value by connecting participants",
                        "C": "Pipelines are always smaller than platforms",
                        "D": "Pipelines require more employees than platforms"
                    },
                    "correct": "B",
                    "explanation": "The fundamental distinction is the value creation model: pipelines follow a linear make-and-sell approach, while platforms create value by facilitating direct interactions between participants who create value for each other.",
                    "difficulty": "easy"
                },
                {
                    "id": 2,
                    "question": "A platform's key asset is:",
                    "options": {
                        "A": "Physical inventory and production facilities",
                        "B": "Its user base, data, and network effects",
                        "C": "Intellectual property and patents",
                        "D": "Its brand reputation alone"
                    },
                    "correct": "B",
                    "explanation": "Unlike pipelines that rely on physical assets and inventory, platforms derive their competitive advantage from their user network, the data generated by interactions, and the resulting network effects that make the platform more valuable as it grows.",
                    "difficulty": "easy"
                },
                {
                    "id": 3,
                    "question": "When a platform adds more users, the typical growth pattern is:",
                    "options": {
                        "A": "Linear increase in value, similar to a factory adding production capacity",
                        "B": "No change in value per user",
                        "C": "Non-linear increase in value per user",
                        "D": "Decrease in value due to congestion"
                    },
                    "correct": "C",
                    "explanation": "Platforms exhibit non-linear growth because each new user can potentially interact with every existing user, creating exponentially more connections and value. This contrasts with pipelines where growth is linear (more inputs produce proportionally more outputs).",
                    "difficulty": "easy"
                },
                {
                    "id": 4,
                    "question": "According to Parker, Van Alstyne, and Choudary (2016), which of these is NOT one of the four key characteristics that define a platform?",
                    "options": {
                        "A": "Two or more distinct user groups",
                        "B": "The platform directly manufactures the product sold to users",
                        "C": "Interdependence between the different sides",
                        "D": "Value is created by participants, not the platform itself"
                    },
                    "correct": "B",
                    "explanation": "The four defining characteristics are: (1) two or more distinct sides, (2) interdependence between sides, (3) platform orchestrates interaction, and (4) value created by participants. Manufacturing a product is a pipeline characteristic, not a platform characteristic.",
                    "difficulty": "medium"
                },
                {
                    "id": 5,
                    "question": "In the platform taxonomy based on transaction vs innovation focus, a payment network (like Visa or Mastercard) is best classified as:",
                    "options": {
                        "A": "Transaction platform",
                        "B": "Innovation platform",
                        "C": "Investment platform",
                        "D": "Integrated platform"
                    },
                    "correct": "A",
                    "explanation": "Payment networks primarily facilitate transactions (exchanges of value) between cardholders and merchants. They focus on enabling exchanges rather than providing a foundation for third-party innovation or combining both functions.",
                    "difficulty": "easy"
                },
                {
                    "id": 6,
                    "question": "What distinguishes a true platform from a traditional business that simply uses technology (like a bank with a mobile app)?",
                    "options": {
                        "A": "The amount of technology investment",
                        "B": "Having interdependent user groups where value is created by participant interactions",
                        "C": "The size of the user base",
                        "D": "Operating primarily online rather than with physical locations"
                    },
                    "correct": "B",
                    "explanation": "Technology alone does not make a platform. A true platform requires interdependent sides and value created by participants interacting with each other. A bank with a mobile app is still a pipeline (the bank creates the financial products); it's just using technology as a distribution channel.",
                    "difficulty": "medium"
                },
                {
                    "id": 7,
                    "question": "Rochet and Tirole's (2003) foundational insight about two-sided markets is that:",
                    "options": {
                        "A": "Total price level is the only factor that matters",
                        "B": "Price structure (how price is divided between sides) matters, not just price level",
                        "C": "Both sides should always be charged the same price",
                        "D": "Free services cannot be sustainable business models"
                    },
                    "correct": "B",
                    "explanation": "Rochet and Tirole formalized that in two-sided markets, the price structure (how the total price is allocated between sides) affects transaction volume, not just the overall price level. This justifies cross-subsidization: charging more to one side and less (or nothing) to the other to maximize total participation.",
                    "difficulty": "medium"
                },
                {
                    "id": 8,
                    "question": "Network effects differ from economies of scale in that network effects are:",
                    "options": {
                        "A": "A cost-side advantage while economies of scale are demand-side",
                        "B": "A demand-side advantage (more users = more value per user) while economies of scale are cost-side",
                        "C": "The same concept with a different name",
                        "D": "Only applicable to technology companies"
                    },
                    "correct": "B",
                    "explanation": "Network effects are a demand-side advantage: more users increase the value of the service for each user. Economies of scale are a cost-side advantage: higher production volume reduces unit cost. Both create barriers to entry but through fundamentally different mechanisms.",
                    "difficulty": "medium"
                },
                {
                    "id": 9,
                    "question": "Direct (same-side) network effects occur when:",
                    "options": {
                        "A": "More users on Side A increase value for Side B",
                        "B": "More users on the same side increase value for other users on that same side",
                        "C": "The platform's algorithms improve with usage",
                        "D": "More users create congestion and reduce value"
                    },
                    "correct": "B",
                    "explanation": "Direct network effects happen within the same user group. For example, a messaging app becomes more useful to you when more of your friends join (same-side users). This contrasts with indirect/cross-side effects where growth on one side benefits the other side.",
                    "difficulty": "easy"
                },
                {
                    "id": 10,
                    "question": "A credit card network becomes more valuable to merchants when more cardholders join. This is an example of:",
                    "options": {
                        "A": "Direct network effects",
                        "B": "Indirect (cross-side) network effects",
                        "C": "Data network effects",
                        "D": "Negative network effects"
                    },
                    "correct": "B",
                    "explanation": "This is a classic example of indirect or cross-side network effects: growth on Side A (cardholders) increases value for Side B (merchants). More cardholders make it worthwhile for merchants to accept the card, and more accepting merchants make the card more useful to cardholders.",
                    "difficulty": "easy"
                },
                {
                    "id": 11,
                    "question": "Data network effects occur when:",
                    "options": {
                        "A": "Users share data directly with each other",
                        "B": "More usage generates more data, which improves algorithms, which improves the product",
                        "C": "The platform sells user data to advertisers",
                        "D": "Users prefer platforms with larger datasets"
                    },
                    "correct": "B",
                    "explanation": "Data network effects create a virtuous cycle: more users generate more data, the platform uses this data to improve algorithms and models (like risk scoring or recommendations), and the improved product attracts more users. This is particularly powerful in financial platforms analyzing credit risk or fraud.",
                    "difficulty": "easy"
                },
                {
                    "id": 12,
                    "question": "A lending platform processes thousands of loan applications and uses this data to build increasingly accurate risk models. This illustrates:",
                    "options": {
                        "A": "Direct network effects",
                        "B": "Economies of scale",
                        "C": "Data network effects",
                        "D": "Negative network effects"
                    },
                    "correct": "C",
                    "explanation": "This is a classic data network effect: cumulative usage (loan applications) generates data that improves the core product (risk assessment algorithms), making the platform better at pricing loans and reducing defaults. The more the platform is used, the better it becomes.",
                    "difficulty": "easy"
                },
                {
                    "id": 13,
                    "question": "Negative network effects can occur when:",
                    "options": {
                        "A": "The platform raises prices too high",
                        "B": "More users create congestion, spam, or fraud that reduces value for others",
                        "C": "The platform lacks sufficient technology infrastructure",
                        "D": "Competitors enter the market"
                    },
                    "correct": "B",
                    "explanation": "Negative network effects happen when growth itself damages the user experience. Examples include congestion (platform slows down), spam (low-quality content overwhelms quality), and fraud (bad actors erode trust). Unmanaged rapid growth can turn positive network effects into negative ones.",
                    "difficulty": "easy"
                },
                {
                    "id": 14,
                    "question": "According to the non-linear growth principle (related to Metcalfe's Law), the value of a network grows roughly proportional to:",
                    "options": {
                        "A": "The number of users (linear growth)",
                        "B": "The square of the number of users",
                        "C": "The natural logarithm of the number of users",
                        "D": "A fixed constant regardless of users"
                    },
                    "correct": "B",
                    "explanation": "Metcalfe's Law suggests network value grows roughly as the square of users (nÂ²) or as n(n-1)/2 possible connections. If you have 3 users, there are 3 possible conversations; with 6 users, there are 15 possible conversations. This non-linear growth explains why platforms 'explode' once they reach critical mass.",
                    "difficulty": "medium"
                },
                {
                    "id": 15,
                    "question": "Critical mass in platform economics refers to:",
                    "options": {
                        "A": "The point where the platform becomes profitable",
                        "B": "The minimum number of users needed for self-sustaining growth (organic growth exceeds churn)",
                        "C": "The maximum number of users the technology can support",
                        "D": "The total addressable market size"
                    },
                    "correct": "B",
                    "explanation": "Critical mass is the tipping point where the platform becomes self-sustaining: organic growth from network effects exceeds user churn without requiring subsidies. Below critical mass, users leave faster than they join because the platform lacks sufficient value; above it, growth accelerates naturally.",
                    "difficulty": "easy"
                },
                {
                    "id": 16,
                    "question": "For a market to 'tip' toward winner-take-most dominance, which three conditions must ALL be present?",
                    "options": {
                        "A": "Large marketing budget, good technology, strong brand",
                        "B": "Strong network effects, high switching costs, low multi-homing",
                        "C": "Government support, first-mover advantage, venture funding",
                        "D": "Low prices, global reach, mobile-first design"
                    },
                    "correct": "B",
                    "explanation": "Three conditions enable market tipping: (1) strong network effects (each new user adds significant value), (2) high switching costs (painful to leave), and (3) low multi-homing (difficult to use multiple platforms simultaneously). When all three are present, one platform typically captures 60-80% market share.",
                    "difficulty": "hard"
                },
                {
                    "id": 17,
                    "question": "Winner-take-all vs winner-take-most: in reality, true winner-take-all (100% market share) is:",
                    "options": {
                        "A": "The common outcome for most platform markets",
                        "B": "Rare; winner-take-most (60-80% share) is more common",
                        "C": "Only possible with government monopoly protection",
                        "D": "Impossible in digital markets"
                    },
                    "correct": "B",
                    "explanation": "While 'winner-take-all' is often discussed, true 100% monopolies are rare even in strong network effect markets. More commonly, the leading platform captures 60-80% share (winner-take-most) due to factors like multi-homing, niche differentiation, and geographic/demographic segmentation.",
                    "difficulty": "medium"
                },
                {
                    "id": 18,
                    "question": "Multi-homing refers to:",
                    "options": {
                        "A": "A platform operating in multiple countries or regions",
                        "B": "Users accessing a platform from multiple devices (phone, tablet, desktop)",
                        "C": "Users simultaneously using multiple competing platforms for the same purpose",
                        "D": "A platform offering multiple product categories"
                    },
                    "correct": "C",
                    "explanation": "Multi-homing means using multiple competing platforms simultaneously (e.g., ride-hailing drivers running both Uber and Lyft, or consumers comparing prices on multiple shopping sites). When multi-homing is easy, competition persists and markets don't tip to a single dominant winner.",
                    "difficulty": "easy"
                },
                {
                    "id": 19,
                    "question": "Why might platforms prefer to increase switching costs while regulators try to reduce them?",
                    "options": {
                        "A": "Platforms earn revenue from switching fees",
                        "B": "High switching costs lock in users and prevent them from leaving for competitors; regulators want to maintain competition",
                        "C": "Regulators want users to switch platforms frequently for no particular reason",
                        "D": "Switching costs are irrelevant to platform strategy"
                    },
                    "correct": "B",
                    "explanation": "Platforms benefit from high switching costs because locked-in users can't easily leave even if competitor offers better terms. This allows the platform to raise prices or reduce quality once dominant. Regulators recognize this and often mandate data portability and interoperability to reduce switching costs and maintain competition.",
                    "difficulty": "hard"
                },
                {
                    "id": 20,
                    "question": "Synthesizing Sections 1-2: The core competitive advantage of a successful platform comes from:",
                    "options": {
                        "A": "Superior technology that competitors cannot replicate",
                        "B": "Network effects that create a compounding advantage as the user base grows",
                        "C": "Lower operating costs through automation",
                        "D": "Better marketing and brand awareness"
                    },
                    "correct": "B",
                    "explanation": "While technology, costs, and marketing matter, the defining competitive moat of platforms is network effects: as the user base grows, value per user increases non-linearly, making it very difficult for new entrants to compete even with superior technology. This demand-side advantage compounds over time in ways that cost advantages or branding alone cannot replicate.",
                    "difficulty": "medium"
                }
            ]
        };

        const state = {
            currentIndex: 0,
            answers: {},
            score: 0,
            displayedQuestions: [],
            pendingSlots: []
        };

        const questionsRow = document.getElementById('questionsRow');
        const progressBar = document.getElementById('progressBar');
        const progressBadge = document.getElementById('progressBadge');
        const scoreBadge = document.getElementById('scoreBadge');
        const resultsCard = document.getElementById('resultsCard');
        const nextBtn = document.getElementById('nextBtn');

        function initQuiz() {
            state.currentIndex = 0;
            state.answers = {};
            state.score = 0;
            state.displayedQuestions = [];
            state.pendingSlots = [];

            resultsCard.classList.remove('show');
            questionsRow.style.display = 'grid';
            nextBtn.classList.remove('show');

            // Show first 3 questions
            for (let i = 0; i < 3 && i < quizData.questions.length; i++) {
                state.displayedQuestions.push(i);
            }
            state.currentIndex = Math.min(3, quizData.questions.length);

            renderQuestions();
            updateStats();
        }

        function renderQuestions() {
            questionsRow.innerHTML = '';

            state.displayedQuestions.forEach((qIdx, slot) => {
                const q = quizData.questions[qIdx];
                const answered = state.answers[q.id] !== undefined;
                const isCorrect = answered && state.answers[q.id] === q.correct;
                const isIncorrect = answered && state.answers[q.id] !== q.correct;

                const card = document.createElement('div');
                card.className = 'question-card';
                if (isCorrect) card.classList.add('correct-card', 'answered');
                if (isIncorrect) card.classList.add('incorrect-card', 'answered');

                card.innerHTML = `
                    <div class="q-header">
                        <span class="q-number">Q${qIdx + 1}</span>
                        ${answered ? `<span class="q-status">${isCorrect ? '&#10004;' : '&#10008;'}</span>` : ''}
                    </div>
                    <div class="q-text">${q.question}</div>
                    <div class="options" data-qid="${q.id}" data-slot="${slot}">
                        ${['A','B','C','D'].map(letter => {
                            let optClass = 'option-btn';
                            if (answered) {
                                optClass += ' disabled';
                                if (letter === q.correct) optClass += ' correct';
                                else if (letter === state.answers[q.id]) optClass += ' incorrect';
                            }
                            return `
                                <button class="${optClass}" data-letter="${letter}" ${answered ? 'disabled' : ''}>
                                    <span class="option-letter">${letter}</span>
                                    <span class="option-text">${q.options[letter]}</span>
                                </button>
                            `;
                        }).join('')}
                    </div>
                    <div class="feedback ${answered ? 'show' : ''} ${isCorrect ? 'correct' : 'incorrect'}">
                        ${answered ? (isCorrect ? '&#10004; ' : `&#10008; Answer: ${q.correct}. `) + q.explanation : ''}
                    </div>
                `;

                // Add click handlers
                if (!answered) {
                    card.querySelectorAll('.option-btn').forEach(btn => {
                        btn.addEventListener('click', () => handleAnswer(qIdx, slot, btn.dataset.letter));
                    });
                }

                questionsRow.appendChild(card);
            });

            renderMath();
        }

        function handleAnswer(qIdx, slot, letter) {
            const q = quizData.questions[qIdx];
            state.answers[q.id] = letter;

            if (letter === q.correct) state.score++;

            // Track this slot as pending replacement
            if (!state.pendingSlots.includes(slot)) {
                state.pendingSlots.push(slot);
            }

            updateStats();
            renderQuestions();

            // Check if all questions answered
            const answered = Object.keys(state.answers).length;
            if (answered >= quizData.questions.length) {
                // Short delay then show results
                setTimeout(showResults, 800);
            } else if (state.currentIndex < quizData.questions.length && state.pendingSlots.length > 0) {
                // Show Next button if there are more questions and pending slots
                nextBtn.classList.add('show');
            }
        }

        function loadNextQuestions() {
            // Replace pending slots with new questions
            while (state.pendingSlots.length > 0 && state.currentIndex < quizData.questions.length) {
                const slot = state.pendingSlots.shift();
                state.displayedQuestions[slot] = state.currentIndex;
                state.currentIndex++;
            }

            // Hide Next button
            nextBtn.classList.remove('show');

            renderQuestions();

            // Check if quiz is complete (all displayed questions answered)
            const answered = Object.keys(state.answers).length;
            if (answered >= quizData.questions.length) {
                setTimeout(showResults, 500);
            }
        }

        function updateStats() {
            const answered = Object.keys(state.answers).length;
            const total = quizData.questions.length;

            progressBar.style.width = `${(answered / total) * 100}%`;
            progressBadge.textContent = `${answered}/${total}`;
            scoreBadge.textContent = `Score: ${state.score}`;
        }

        function showResults() {
            questionsRow.style.display = 'none';
            nextBtn.classList.remove('show');
            resultsCard.classList.add('show');

            const total = quizData.questions.length;
            const percentage = Math.round((state.score / total) * 100);

            document.getElementById('resultsScore').textContent = `${state.score}/${total}`;

            let grade, gradeClass, icon;
            if (percentage >= 90) { grade = 'Excellent! A'; gradeClass = 'grade-a'; icon = '&#127942;'; }
            else if (percentage >= 80) { grade = 'Great! B'; gradeClass = 'grade-b'; icon = '&#11088;'; }
            else if (percentage >= 70) { grade = 'Good! C'; gradeClass = 'grade-c'; icon = '&#128077;'; }
            else if (percentage >= 60) { grade = 'Pass - D'; gradeClass = 'grade-d'; icon = '&#128221;'; }
            else { grade = 'Keep practicing'; gradeClass = 'grade-f'; icon = '&#128218;'; }

            document.getElementById('resultsIcon').innerHTML = icon;
            const gradeEl = document.getElementById('resultsGrade');
            gradeEl.textContent = `${grade} (${percentage}%)`;
            gradeEl.className = `results-grade ${gradeClass}`;
        }

        function restartQuiz() {
            initQuiz();
        }

        function renderMath() {
            if (typeof renderMathInElement !== 'undefined') {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initQuiz();
            setTimeout(renderMath, 100);
        });
    </script>
</body>
</html>
