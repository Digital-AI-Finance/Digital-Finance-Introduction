<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz 13: Robo Advisor | Digital Finance</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
        :root {
            --mlpurple: #3333B2;
            --mlblue: #0066CC;
            --quiz-accent: #8b5cf6;
            --quiz-light: #ede9fe;
            --correct: #22c55e;
            --correct-bg: #dcfce7;
            --incorrect: #ef4444;
            --incorrect-bg: #fee2e2;
            --bg: #f6f8fa;
            --card-bg: #ffffff;
            --text: #24292e;
            --text-secondary: #586069;
            --border: #e1e4e8;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.4;
            min-height: 100vh;
        }

        .nav {
            background: linear-gradient(135deg, var(--mlpurple), var(--mlblue));
            color: white;
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-title { font-weight: 600; font-size: 14px; }
        .nav-links { display: flex; gap: 16px; }
        .nav-links a { color: white; text-decoration: none; font-size: 12px; opacity: 0.9; }
        .nav-links a:hover { opacity: 1; }

        .quiz-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 12px;
        }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 0 4px;
        }
        .quiz-title { font-size: 16px; font-weight: 600; color: var(--mlpurple); }
        .quiz-stats {
            display: flex;
            gap: 12px;
            font-size: 12px;
        }
        .stat-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
        }
        .stat-progress { background: var(--quiz-light); color: var(--quiz-accent); }
        .stat-score { background: var(--correct-bg); color: var(--correct); }

        .progress-bar-container {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin-bottom: 12px;
        }
        .progress-bar {
            height: 100%;
            background: var(--quiz-accent);
            border-radius: 2px;
            transition: width 0.3s;
        }

        /* Three-column layout */
        .questions-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .question-card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 12px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            min-height: 280px;
        }

        .question-card.answered { opacity: 0.7; }

        .question-card.correct-card {
            border: 2px solid var(--correct);
            background: linear-gradient(to bottom, var(--correct-bg), var(--card-bg));
        }

        .question-card.incorrect-card {
            border: 2px solid var(--incorrect);
            background: linear-gradient(to bottom, var(--incorrect-bg), var(--card-bg));
        }

        .q-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .q-number {
            background: var(--quiz-light);
            color: var(--quiz-accent);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        .q-status { font-size: 14px; }

        .q-text {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 10px;
            line-height: 1.4;
            flex-grow: 0;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex-grow: 1;
        }

        .option-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            min-height: 44px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--card-bg);
            cursor: pointer;
            transition: all 0.15s;
            text-align: left;
            font-size: 12px;
        }

        .option-btn:hover:not(.disabled) {
            border-color: var(--quiz-accent);
            background: var(--quiz-light);
        }

        .option-btn.correct {
            border-color: var(--correct);
            background: var(--correct-bg);
        }

        .option-btn.incorrect {
            border-color: var(--incorrect);
            background: var(--incorrect-bg);
        }

        .option-btn.disabled { cursor: default; }

        .option-letter {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 10px;
            flex-shrink: 0;
        }

        .option-btn.correct .option-letter {
            background: var(--correct);
            color: white;
        }

        .option-btn.incorrect .option-letter {
            background: var(--incorrect);
            color: white;
        }

        .option-text { flex: 1; }

        .feedback {
            margin-top: 8px;
            padding: 8px;
            border-radius: 6px;
            font-size: 10px;
            line-height: 1.4;
            display: none;
        }

        .feedback.show { display: block; }
        .feedback.correct { background: var(--correct-bg); color: #166534; }
        .feedback.incorrect { background: var(--incorrect-bg); color: #991b1b; }

        /* Results */
        .results-card {
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 32px;
            text-align: center;
            max-width: 500px;
            margin: 40px auto;
            display: none;
        }
        .results-card.show { display: block; }
        .results-icon { font-size: 48px; margin-bottom: 8px; }
        .results-score { font-size: 36px; font-weight: 700; color: var(--quiz-accent); }
        .results-label { font-size: 14px; color: var(--text-secondary); margin-bottom: 16px; }
        .results-grade {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        .grade-a { background: #dcfce7; color: #166534; }
        .grade-b { background: #dbeafe; color: #1e40af; }
        .grade-c { background: #fef3c7; color: #92400e; }
        .grade-d { background: #fed7aa; color: #9a3412; }
        .grade-f { background: #fee2e2; color: #991b1b; }

        .results-buttons { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            text-decoration: none;
        }
        .btn-primary { background: var(--quiz-accent); color: white; }
        .btn-primary:hover { background: #7c3aed; }
        .btn-secondary { background: var(--card-bg); color: var(--text); border: 1px solid var(--border); }

        /* Next button container */
        .next-btn-container {
            display: flex;
            justify-content: center;
            margin-top: 16px;
        }
        .btn-next {
            padding: 10px 32px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            background: var(--quiz-accent);
            color: white;
            transition: all 0.2s;
            display: none;
        }
        .btn-next:hover { background: #7c3aed; transform: scale(1.02); }
        .btn-next.show { display: inline-block; }
        .btn-next:disabled { opacity: 0.5; cursor: not-allowed; }

        @media (max-width: 900px) {
            .questions-row { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 600px) {
            .questions-row { grid-template-columns: 1fr; }
            .question-card { min-height: auto; }
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-title">Quiz 13: Robo Advisor</div>
        <div class="nav-links">
            <a href="../index.html">Dashboard</a>
            
            <a href="https://github.com/Digital-AI-Finance/Digital-Finance-Introduction" target="_blank">GitHub</a>
        </div>
    </nav>

    <main class="quiz-container">
        <div class="quiz-header">
            <div class="quiz-title">Quiz 13: Robo Advisor</div>
            <div class="quiz-stats">
                <span class="stat-badge stat-progress" id="progressBadge">0/20</span>
                <span class="stat-badge stat-score" id="scoreBadge">Score: 0</span>
            </div>
        </div>

        <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>

        <div class="questions-row" id="questionsRow"></div>

        <div class="next-btn-container">
            <button class="btn-next" id="nextBtn" onclick="loadNextQuestions()">Next</button>
        </div>

        <div class="results-card" id="resultsCard">
            <div class="results-icon" id="resultsIcon"></div>
            <div class="results-score" id="resultsScore"></div>
            <div class="results-label">Correct Answers</div>
            <div class="results-grade" id="resultsGrade"></div>
            <div class="results-buttons">
                <button class="btn btn-primary" onclick="restartQuiz()">Try Again</button>
                <a href="../index.html" class="btn btn-secondary">Dashboard</a>
            </div>
        </div>
    </main>

    <script>
        const quizData = {
            questions: [
                {
                                "id": 1,
                                "question": "What is a robo-advisor?",
                                "options": {
                                                "A": "A human financial advisor who uses robots to execute trades",
                                                "B": "An automated platform that provides digital financial advice and investment management with minimal human intervention",
                                                "C": "A software tool that only provides stock price predictions",
                                                "D": "A type of cryptocurrency trading bot"
                                },
                                "correct": "B",
                                "difficulty": "easy",
                                "explanation": "A robo-advisor is an automated platform that provides digital financial advice and investment management with minimal human intervention. They use algorithms to assess risk tolerance, build portfolios, rebalance automatically, and optimize taxes."
                },
                {
                                "id": 2,
                                "question": "What is the typical annual fee range for robo-advisors compared to traditional advisors?",
                                "options": {
                                                "A": "Robo: 2-3%, Traditional: 4-5%",
                                                "B": "Robo: 0.15-0.50%, Traditional: 1.00-2.00%",
                                                "C": "Robo: 5-10%, Traditional: 1-2%",
                                                "D": "Both charge the same: 1-2%"
                                },
                                "correct": "B",
                                "difficulty": "easy",
                                "explanation": "Robo-advisors typically charge 0.15-0.50% of assets under management (AUM) per year, while traditional advisors charge 1.00-2.00%. This significant difference in fees can result in hundreds of thousands of dollars in savings over a long investment horizon."
                },
                {
                                "id": 3,
                                "question": "Which mathematical framework forms the foundation of robo-advisor portfolio construction?",
                                "options": {
                                                "A": "Black-Scholes Model",
                                                "B": "Capital Asset Pricing Model (CAPM)",
                                                "C": "Modern Portfolio Theory (MPT) by Harry Markowitz",
                                                "D": "Arbitrage Pricing Theory (APT)"
                                },
                                "correct": "C",
                                "difficulty": "easy",
                                "explanation": "Modern Portfolio Theory (MPT), developed by Harry Markowitz in 1952, forms the mathematical foundation of robo-advisors. The key insight is that diversification reduces risk without necessarily reducing returns. MPT uses mean-variance optimization to find optimal asset allocations."
                },
                {
                                "id": 4,
                                "question": "What is the formula for portfolio expected return given weights $w$ and expected returns $\\mu$?",
                                "options": {
                                                "A": "$r_p = w \\times \\mu$",
                                                "B": "$r_p = w^T \\mu$",
                                                "C": "$r_p = \\sqrt{w^T \\mu}$",
                                                "D": "$r_p = \\mu / w$"
                                },
                                "correct": "B",
                                "difficulty": "medium",
                                "explanation": "Portfolio expected return is calculated as $r_p = w^T \\mu$, which is the dot product of the weight vector and the expected returns vector. This gives the weighted average of individual asset returns."
                },
                {
                                "id": 5,
                                "question": "What is the formula for portfolio variance given weights $w$ and covariance matrix $\\Sigma$?",
                                "options": {
                                                "A": "$\\sigma_p^2 = w \\times \\Sigma$",
                                                "B": "$\\sigma_p^2 = w + \\Sigma$",
                                                "C": "$\\sigma_p^2 = w^T \\Sigma w$",
                                                "D": "$\\sigma_p^2 = \\Sigma / w$"
                                },
                                "correct": "C",
                                "difficulty": "medium",
                                "explanation": "Portfolio variance is calculated as $\\sigma_p^2 = w^T \\Sigma w$, where $w$ is the weight vector and $\\Sigma$ is the covariance matrix. This quadratic form accounts for both individual asset variances and the correlations between assets."
                },
                {
                                "id": 6,
                                "question": "What does the efficient frontier represent?",
                                "options": {
                                                "A": "The maximum possible return for any investment",
                                                "B": "The set of portfolios that maximize return for a given level of risk, or minimize risk for a given return",
                                                "C": "The boundary between stocks and bonds in a portfolio",
                                                "D": "The line connecting the risk-free asset to the highest return asset"
                                },
                                "correct": "B",
                                "difficulty": "medium",
                                "explanation": "The efficient frontier shows all optimal portfolios - those that maximize expected return for a given level of risk, or minimize risk for a given expected return. Portfolios below the frontier are suboptimal, while portfolios above are impossible to achieve."
                },
                {
                                "id": 7,
                                "question": "What is the Sharpe ratio and what does it measure?",
                                "options": {
                                                "A": "The ratio of volatility to return, measuring absolute performance",
                                                "B": "The ratio of excess return over the risk-free rate to volatility, measuring risk-adjusted return",
                                                "C": "The ratio of stocks to bonds in a portfolio",
                                                "D": "The ratio of dividends to price, measuring income yield"
                                },
                                "correct": "B",
                                "difficulty": "medium",
                                "explanation": "The Sharpe ratio is calculated as $(r_p - r_f) / \\sigma_p$, where $r_p$ is portfolio return, $r_f$ is the risk-free rate, and $\\sigma_p$ is portfolio volatility. It measures risk-adjusted return - how much excess return you receive per unit of risk taken. Higher Sharpe ratios indicate better risk-adjusted performance."
                },
                {
                                "id": 8,
                                "question": "In the Sharpe ratio formula $(r_p - r_f) / \\sigma_p$, what does $r_f$ typically represent?",
                                "options": {
                                                "A": "The inflation rate",
                                                "B": "The expected market return",
                                                "C": "The risk-free rate, such as the Treasury bill rate",
                                                "D": "The firm's cost of capital"
                                },
                                "correct": "C",
                                "difficulty": "easy",
                                "explanation": "In the Sharpe ratio, $r_f$ represents the risk-free rate, typically approximated by short-term Treasury bills (e.g., 2-3%). This is the return an investor could earn with virtually no risk, and the Sharpe ratio measures excess return above this baseline."
                },
                {
                                "id": 9,
                                "question": "What is the primary purpose of a risk profiling questionnaire in robo-advisors?",
                                "options": {
                                                "A": "To determine the investor's age only",
                                                "B": "To assess risk tolerance and map investor characteristics to appropriate portfolio allocations",
                                                "C": "To collect personal information for marketing purposes",
                                                "D": "To predict future market returns"
                                },
                                "correct": "B",
                                "difficulty": "easy",
                                "explanation": "Risk profiling questionnaires assess investor characteristics such as time horizon, reaction to losses, investment goals, experience, and income stability. These factors are combined into a risk tolerance score that drives portfolio allocation decisions, ensuring the portfolio matches the investor's ability and willingness to take risk."
                },
                {
                                "id": 10,
                                "question": "What is strategic asset allocation?",
                                "options": {
                                                "A": "Frequently changing allocations based on short-term market predictions",
                                                "B": "A long-term target allocation based on investor goals and risk tolerance, maintained through rebalancing",
                                                "C": "Allocating 100% to the highest returning asset",
                                                "D": "Random allocation across available assets"
                                },
                                "correct": "B",
                                "difficulty": "medium",
                                "explanation": "Strategic asset allocation involves setting long-term target weights for different asset classes based on the investor's goals, time horizon, and risk tolerance. This allocation is maintained over time through periodic rebalancing, regardless of short-term market movements. It contrasts with tactical allocation, which involves active adjustments based on market views."
                },
                {
                                "id": 11,
                                "question": "What triggers a rebalance in threshold-based rebalancing?",
                                "options": {
                                                "A": "A fixed calendar date, such as quarterly or annually",
                                                "B": "When any asset allocation drifts beyond a specified percentage from its target weight",
                                                "C": "When the portfolio value reaches a certain dollar amount",
                                                "D": "When the investor requests it manually"
                                },
                                "correct": "B",
                                "difficulty": "medium",
                                "explanation": "In threshold-based rebalancing, trades are triggered when any asset's actual weight drifts beyond a specified threshold from its target (e.g., 5%). This approach minimizes unnecessary trading while ensuring the portfolio doesn't drift too far from its strategic allocation. It contrasts with calendar rebalancing, which rebalances on fixed dates."
                },
                {
                                "id": 12,
                                "question": "What is tax-loss harvesting?",
                                "options": {
                                                "A": "Delaying the sale of profitable investments to defer taxes",
                                                "B": "Selling investments at a loss to offset capital gains and reduce taxes, then replacing with similar assets",
                                                "C": "Contributing to tax-advantaged retirement accounts",
                                                "D": "Avoiding all taxable accounts to minimize taxes"
                                },
                                "correct": "B",
                                "difficulty": "medium",
                                "explanation": "Tax-loss harvesting involves selling investments that have declined in value to realize losses, which can offset capital gains and reduce tax liability. The proceeds are immediately reinvested in similar (but not substantially identical) assets to maintain portfolio exposure while capturing the tax benefit."
                },
                {
                                "id": 13,
                                "question": "What is the wash sale rule in tax-loss harvesting?",
                                "options": {
                                                "A": "You must wash your hands before trading stocks",
                                                "B": "You cannot buy a substantially identical security within 30 days before or after the sale, or the loss is disallowed",
                                                "C": "You must sell all losing positions at year-end",
                                                "D": "You cannot harvest losses more than once per year"
                                },
                                "correct": "B",
                                "difficulty": "hard",
                                "explanation": "The wash sale rule states that if you sell a security at a loss and buy a substantially identical security within 30 days before or after the sale, the loss is disallowed for tax purposes. This prevents investors from claiming artificial losses while maintaining the same position. Robo-advisors work around this by using similar but not identical replacement securities."
                },
                {
                                "id": 14,
                                "question": "In mean-variance optimization, what is being minimized to find the minimum volatility portfolio?",
                                "options": {
                                                "A": "The portfolio's expected return",
                                                "B": "The portfolio's variance (or volatility), which is $\\sigma_p^2 = w^T \\Sigma w$",
                                                "C": "The number of assets in the portfolio",
                                                "D": "The correlation between assets"
                                },
                                "correct": "B",
                                "difficulty": "hard",
                                "explanation": "In mean-variance optimization, finding the minimum volatility portfolio involves minimizing the portfolio variance $\\sigma_p^2 = w^T \\Sigma w$ subject to the constraint that weights sum to 1. This is a quadratic programming problem that identifies the least risky combination of assets."
                },
                {
                                "id": 15,
                                "question": "Why does diversification reduce portfolio risk without necessarily reducing returns?",
                                "options": {
                                                "A": "Because diversified portfolios always have higher returns",
                                                "B": "Because assets with less than perfect positive correlation can offset each other's volatility while maintaining expected returns",
                                                "C": "Because transaction costs are lower with more assets",
                                                "D": "Because tax benefits increase with more holdings"
                                },
                                "correct": "B",
                                "difficulty": "hard",
                                "explanation": "Diversification reduces risk through imperfect correlation between assets. When assets don't move in perfect lockstep (correlation < 1), their individual volatilities partially offset each other, reducing overall portfolio variance. Meanwhile, expected portfolio return remains the weighted average of individual returns. This is the key insight of Modern Portfolio Theory."
                },
                {
                                "id": 16,
                                "question": "What role does the correlation matrix play in portfolio construction?",
                                "options": {
                                                "A": "It determines the expected returns of individual assets",
                                                "B": "It measures how assets move together and is essential for calculating portfolio variance",
                                                "C": "It shows which assets have the highest fees",
                                                "D": "It predicts future asset prices"
                                },
                                "correct": "B",
                                "difficulty": "hard",
                                "explanation": "The correlation matrix shows how pairs of assets move together. It's combined with individual asset volatilities to create the covariance matrix, which is crucial for calculating portfolio variance: $\\sigma_p^2 = w^T \\Sigma w$. Low or negative correlations between assets enable diversification benefits, while high correlations limit risk reduction potential."
                },
                {
                                "id": 17,
                                "question": "What is the Black-Litterman model used for in advanced robo-advisors?",
                                "options": {
                                                "A": "Predicting stock prices with 100% accuracy",
                                                "B": "Combining market equilibrium returns with investor views to create more stable and intuitive portfolio allocations",
                                                "C": "Calculating transaction costs",
                                                "D": "Determining tax rates for different investments"
                                },
                                "correct": "B",
                                "difficulty": "hard",
                                "explanation": "The Black-Litterman model is an advanced portfolio optimization approach that combines market equilibrium expected returns (from reverse optimization on market cap weights) with investor-specific views. This produces more diversified and stable allocations than traditional mean-variance optimization alone, which can be sensitive to small changes in expected return estimates."
                },
                {
                                "id": 18,
                                "question": "How do robo-advisor fee structures typically work?",
                                "options": {
                                                "A": "Fixed dollar amount per year regardless of portfolio size",
                                                "B": "Percentage of assets under management (AUM) charged annually",
                                                "C": "Commission on each trade executed",
                                                "D": "Only performance fees if returns exceed a benchmark"
                                },
                                "correct": "B",
                                "difficulty": "easy",
                                "explanation": "Robo-advisors typically charge a percentage of assets under management (AUM) annually, such as 0.25%. This means on a $100,000 portfolio, the fee would be $250 per year. This fee structure aligns incentives (advisor benefits when portfolio grows) and scales with portfolio size, unlike fixed fees or commissions."
                },
                {
                                "id": 19,
                                "question": "Which behavioral bias involves feeling the pain of losses more intensely than the pleasure of equivalent gains?",
                                "options": {
                                                "A": "Overconfidence bias",
                                                "B": "Loss aversion",
                                                "C": "Anchoring bias",
                                                "D": "Recency bias"
                                },
                                "correct": "B",
                                "difficulty": "medium",
                                "explanation": "Loss aversion is the behavioral bias where people feel the pain of losses roughly twice as intensely as the pleasure from equivalent gains. This can lead to poor investment decisions, such as selling winning positions too early or holding losing positions too long. Robo-advisors help mitigate this by automating decisions and removing emotional reactions."
                },
                {
                                "id": 20,
                                "question": "What is a hybrid robo-advisor model?",
                                "options": {
                                                "A": "A robo-advisor that only invests in hybrid vehicles",
                                                "B": "A service combining algorithmic portfolio management with access to human financial advisors",
                                                "C": "A robo-advisor that uses both stocks and bonds",
                                                "D": "A platform that switches between robo and traditional based on market conditions"
                                },
                                "correct": "B",
                                "difficulty": "medium",
                                "explanation": "Hybrid robo-advisor models combine the efficiency and low cost of algorithmic portfolio management with access to human financial advisors for questions, planning, and behavioral coaching. Examples include Vanguard Personal Advisor Services (0.30%) and Betterment Premium (0.40%). These services bridge the gap between pure robo-advisors and traditional advisors."
                }
]
        };

        const state = {
            currentIndex: 0,
            answers: {},
            score: 0,
            displayedQuestions: [],
            pendingSlots: []
        };

        const questionsRow = document.getElementById('questionsRow');
        const progressBar = document.getElementById('progressBar');
        const progressBadge = document.getElementById('progressBadge');
        const scoreBadge = document.getElementById('scoreBadge');
        const resultsCard = document.getElementById('resultsCard');
        const nextBtn = document.getElementById('nextBtn');

        function initQuiz() {
            state.currentIndex = 0;
            state.answers = {};
            state.score = 0;
            state.displayedQuestions = [];
            state.pendingSlots = [];

            resultsCard.classList.remove('show');
            questionsRow.style.display = 'grid';
            nextBtn.classList.remove('show');

            // Show first 3 questions
            for (let i = 0; i < 3 && i < quizData.questions.length; i++) {
                state.displayedQuestions.push(i);
            }
            state.currentIndex = Math.min(3, quizData.questions.length);

            renderQuestions();
            updateStats();
        }

        function renderQuestions() {
            questionsRow.innerHTML = '';

            state.displayedQuestions.forEach((qIdx, slot) => {
                const q = quizData.questions[qIdx];
                const answered = state.answers[q.id] !== undefined;
                const isCorrect = answered && state.answers[q.id] === q.correct;
                const isIncorrect = answered && state.answers[q.id] !== q.correct;

                const card = document.createElement('div');
                card.className = 'question-card';
                if (isCorrect) card.classList.add('correct-card', 'answered');
                if (isIncorrect) card.classList.add('incorrect-card', 'answered');

                card.innerHTML = `
                    <div class="q-header">
                        <span class="q-number">Q${qIdx + 1}</span>
                        ${answered ? `<span class="q-status">${isCorrect ? '&#10004;' : '&#10008;'}</span>` : ''}
                    </div>
                    <div class="q-text">${q.question}</div>
                    <div class="options" data-qid="${q.id}" data-slot="${slot}">
                        ${['A','B','C','D'].map(letter => {
                            let optClass = 'option-btn';
                            if (answered) {
                                optClass += ' disabled';
                                if (letter === q.correct) optClass += ' correct';
                                else if (letter === state.answers[q.id]) optClass += ' incorrect';
                            }
                            return `
                                <button class="${optClass}" data-letter="${letter}" ${answered ? 'disabled' : ''}>
                                    <span class="option-letter">${letter}</span>
                                    <span class="option-text">${q.options[letter]}</span>
                                </button>
                            `;
                        }).join('')}
                    </div>
                    <div class="feedback ${answered ? 'show' : ''} ${isCorrect ? 'correct' : 'incorrect'}">
                        ${answered ? (isCorrect ? '&#10004; ' : `&#10008; Answer: ${q.correct}. `) + q.explanation : ''}
                    </div>
                `;

                // Add click handlers
                if (!answered) {
                    card.querySelectorAll('.option-btn').forEach(btn => {
                        btn.addEventListener('click', () => handleAnswer(qIdx, slot, btn.dataset.letter));
                    });
                }

                questionsRow.appendChild(card);
            });

            renderMath();
        }

        function handleAnswer(qIdx, slot, letter) {
            const q = quizData.questions[qIdx];
            state.answers[q.id] = letter;

            if (letter === q.correct) state.score++;

            // Track this slot as pending replacement
            if (!state.pendingSlots.includes(slot)) {
                state.pendingSlots.push(slot);
            }

            updateStats();
            renderQuestions();

            // Check if all questions answered
            const answered = Object.keys(state.answers).length;
            if (answered >= quizData.questions.length) {
                // Short delay then show results
                setTimeout(showResults, 800);
            } else if (state.currentIndex < quizData.questions.length && state.pendingSlots.length > 0) {
                // Show Next button if there are more questions and pending slots
                nextBtn.classList.add('show');
            }
        }

        function loadNextQuestions() {
            // Replace pending slots with new questions
            while (state.pendingSlots.length > 0 && state.currentIndex < quizData.questions.length) {
                const slot = state.pendingSlots.shift();
                state.displayedQuestions[slot] = state.currentIndex;
                state.currentIndex++;
            }

            // Hide Next button
            nextBtn.classList.remove('show');

            renderQuestions();

            // Check if quiz is complete (all displayed questions answered)
            const answered = Object.keys(state.answers).length;
            if (answered >= quizData.questions.length) {
                setTimeout(showResults, 500);
            }
        }

        function updateStats() {
            const answered = Object.keys(state.answers).length;
            const total = quizData.questions.length;

            progressBar.style.width = `${(answered / total) * 100}%`;
            progressBadge.textContent = `${answered}/${total}`;
            scoreBadge.textContent = `Score: ${state.score}`;
        }

        function showResults() {
            questionsRow.style.display = 'none';
            nextBtn.classList.remove('show');
            resultsCard.classList.add('show');

            const total = quizData.questions.length;
            const percentage = Math.round((state.score / total) * 100);

            document.getElementById('resultsScore').textContent = `${state.score}/${total}`;

            let grade, gradeClass, icon;
            if (percentage >= 90) { grade = 'Excellent! A'; gradeClass = 'grade-a'; icon = '&#127942;'; }
            else if (percentage >= 80) { grade = 'Great! B'; gradeClass = 'grade-b'; icon = '&#11088;'; }
            else if (percentage >= 70) { grade = 'Good! C'; gradeClass = 'grade-c'; icon = '&#128077;'; }
            else if (percentage >= 60) { grade = 'Pass - D'; gradeClass = 'grade-d'; icon = '&#128221;'; }
            else { grade = 'Keep practicing'; gradeClass = 'grade-f'; icon = '&#128218;'; }

            document.getElementById('resultsIcon').innerHTML = icon;
            const gradeEl = document.getElementById('resultsGrade');
            gradeEl.textContent = `${grade} (${percentage}%)`;
            gradeEl.className = `results-grade ${gradeClass}`;
        }

        function restartQuiz() {
            initQuiz();
        }

        function renderMath() {
            if (typeof renderMathInElement !== 'undefined') {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initQuiz();
            setTimeout(renderMath, 100);
        });
    </script>
</body>
</html>
