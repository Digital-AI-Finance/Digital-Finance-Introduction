<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz 4: Credit Scoring | Digital Finance</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
        :root {
            --mlpurple: #3333B2;
            --mlblue: #0066CC;
            --quiz-accent: #8b5cf6;
            --quiz-light: #ede9fe;
            --correct: #22c55e;
            --correct-bg: #dcfce7;
            --incorrect: #ef4444;
            --incorrect-bg: #fee2e2;
            --bg: #f6f8fa;
            --card-bg: #ffffff;
            --text: #24292e;
            --text-secondary: #586069;
            --border: #e1e4e8;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.4;
            min-height: 100vh;
        }

        .nav {
            background: linear-gradient(135deg, var(--mlpurple), var(--mlblue));
            color: white;
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-title { font-weight: 600; font-size: 14px; }
        .nav-links { display: flex; gap: 16px; }
        .nav-links a { color: white; text-decoration: none; font-size: 12px; opacity: 0.9; }
        .nav-links a:hover { opacity: 1; }

        .quiz-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 12px;
        }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 0 4px;
        }
        .quiz-title { font-size: 16px; font-weight: 600; color: var(--mlpurple); }
        .quiz-stats {
            display: flex;
            gap: 12px;
            font-size: 12px;
        }
        .stat-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
        }
        .stat-progress { background: var(--quiz-light); color: var(--quiz-accent); }
        .stat-score { background: var(--correct-bg); color: var(--correct); }

        .progress-bar-container {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin-bottom: 12px;
        }
        .progress-bar {
            height: 100%;
            background: var(--quiz-accent);
            border-radius: 2px;
            transition: width 0.3s;
        }

        /* Three-column layout */
        .questions-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .question-card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 12px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            min-height: 280px;
        }

        .question-card.answered { opacity: 0.7; }

        .question-card.correct-card {
            border: 2px solid var(--correct);
            background: linear-gradient(to bottom, var(--correct-bg), var(--card-bg));
        }

        .question-card.incorrect-card {
            border: 2px solid var(--incorrect);
            background: linear-gradient(to bottom, var(--incorrect-bg), var(--card-bg));
        }

        .q-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .q-number {
            background: var(--quiz-light);
            color: var(--quiz-accent);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        .q-status { font-size: 14px; }

        .q-text {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 10px;
            line-height: 1.4;
            flex-grow: 0;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex-grow: 1;
        }

        .option-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            min-height: 44px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--card-bg);
            cursor: pointer;
            transition: all 0.15s;
            text-align: left;
            font-size: 12px;
        }

        .option-btn:hover:not(.disabled) {
            border-color: var(--quiz-accent);
            background: var(--quiz-light);
        }

        .option-btn.correct {
            border-color: var(--correct);
            background: var(--correct-bg);
        }

        .option-btn.incorrect {
            border-color: var(--incorrect);
            background: var(--incorrect-bg);
        }

        .option-btn.disabled { cursor: default; }

        .option-letter {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 10px;
            flex-shrink: 0;
        }

        .option-btn.correct .option-letter {
            background: var(--correct);
            color: white;
        }

        .option-btn.incorrect .option-letter {
            background: var(--incorrect);
            color: white;
        }

        .option-text { flex: 1; }

        .feedback {
            margin-top: 8px;
            padding: 8px;
            border-radius: 6px;
            font-size: 10px;
            line-height: 1.4;
            display: none;
        }

        .feedback.show { display: block; }
        .feedback.correct { background: var(--correct-bg); color: #166534; }
        .feedback.incorrect { background: var(--incorrect-bg); color: #991b1b; }

        /* Results */
        .results-card {
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 32px;
            text-align: center;
            max-width: 500px;
            margin: 40px auto;
            display: none;
        }
        .results-card.show { display: block; }
        .results-icon { font-size: 48px; margin-bottom: 8px; }
        .results-score { font-size: 36px; font-weight: 700; color: var(--quiz-accent); }
        .results-label { font-size: 14px; color: var(--text-secondary); margin-bottom: 16px; }
        .results-grade {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        .grade-a { background: #dcfce7; color: #166534; }
        .grade-b { background: #dbeafe; color: #1e40af; }
        .grade-c { background: #fef3c7; color: #92400e; }
        .grade-d { background: #fed7aa; color: #9a3412; }
        .grade-f { background: #fee2e2; color: #991b1b; }

        .results-buttons { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            text-decoration: none;
        }
        .btn-primary { background: var(--quiz-accent); color: white; }
        .btn-primary:hover { background: #7c3aed; }
        .btn-secondary { background: var(--card-bg); color: var(--text); border: 1px solid var(--border); }

        /* Next button container */
        .next-btn-container {
            display: flex;
            justify-content: center;
            margin-top: 16px;
        }
        .btn-next {
            padding: 10px 32px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            background: var(--quiz-accent);
            color: white;
            transition: all 0.2s;
            display: none;
        }
        .btn-next:hover { background: #7c3aed; transform: scale(1.02); }
        .btn-next.show { display: inline-block; }
        .btn-next:disabled { opacity: 0.5; cursor: not-allowed; }

        @media (max-width: 900px) {
            .questions-row { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 600px) {
            .questions-row { grid-template-columns: 1fr; }
            .question-card { min-height: auto; }
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-title">Quiz 4: Credit Scoring</div>
        <div class="nav-links">
            <a href="../index.html">Dashboard</a>
            
            <a href="https://github.com/Digital-AI-Finance/Digital-Finance-Introduction" target="_blank">GitHub</a>
        </div>
    </nav>

    <main class="quiz-container">
        <div class="quiz-header">
            <div class="quiz-title">Quiz 4: Credit Scoring</div>
            <div class="quiz-stats">
                <span class="stat-badge stat-progress" id="progressBadge">0/20</span>
                <span class="stat-badge stat-score" id="scoreBadge">Score: 0</span>
            </div>
        </div>

        <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>

        <div class="questions-row" id="questionsRow"></div>

        <div class="next-btn-container">
            <button class="btn-next" id="nextBtn" onclick="loadNextQuestions()">Next</button>
        </div>

        <div class="results-card" id="resultsCard">
            <div class="results-icon" id="resultsIcon"></div>
            <div class="results-score" id="resultsScore"></div>
            <div class="results-label">Correct Answers</div>
            <div class="results-grade" id="resultsGrade"></div>
            <div class="results-buttons">
                <button class="btn btn-primary" onclick="restartQuiz()">Try Again</button>
                <a href="../index.html" class="btn btn-secondary">Dashboard</a>
            </div>
        </div>
    </main>

    <script>
        const quizData = {
            questions: [
                {
                                "id": 1,
                                "question": "What is the primary purpose of a credit scoring model?",
                                "options": {
                                                "A": "To estimate the probability that a borrower will default on a loan",
                                                "B": "To calculate the exact amount a borrower can afford to repay",
                                                "C": "To determine the optimal interest rate for any loan",
                                                "D": "To track a borrower's payment history over time"
                                },
                                "correct": "A",
                                "explanation": "Credit scoring models estimate default probability - the likelihood that a borrower will fail to repay. While this information influences loan amounts and interest rates, the core purpose is risk assessment through probability estimation. Payment history is an input to the model, not its output.",
                                "difficulty": "easy"
                },
                {
                                "id": 2,
                                "question": "In the context of credit scoring, what is credit risk?",
                                "options": {
                                                "A": "The risk that interest rates will change during the loan term",
                                                "B": "The risk that a borrower will fail to repay the loan as agreed",
                                                "C": "The risk that inflation will reduce the real value of repayments",
                                                "D": "The risk that a lender will run out of funds to lend"
                                },
                                "correct": "B",
                                "explanation": "Credit risk specifically refers to the risk that a borrower will default - failing to make scheduled payments or repay the principal. While interest rate risk and inflation risk affect lending economics, credit risk focuses purely on borrower repayment probability. This is what credit scoring models attempt to quantify.",
                                "difficulty": "easy"
                },
                {
                                "id": 3,
                                "question": "Which of the following is NOT a traditional component used in credit scoring?",
                                "options": {
                                                "A": "Payment history on existing credit accounts",
                                                "B": "Current employment status and income",
                                                "C": "Social media connection count",
                                                "D": "Length of credit history"
                                },
                                "correct": "C",
                                "explanation": "Traditional credit scoring relies on established financial data: payment history, income, employment, and credit history length. Social media connections are alternative data - a newer, less regulated source used by some FinTech lenders but not part of traditional models like FICO scores.",
                                "difficulty": "easy"
                },
                {
                                "id": 4,
                                "question": "What is the most heavily weighted component in a FICO credit score?",
                                "options": {
                                                "A": "Credit utilization ratio (35%)",
                                                "B": "Payment history (35%)",
                                                "C": "Length of credit history (15%)",
                                                "D": "New credit inquiries (10%)"
                                },
                                "correct": "B",
                                "explanation": "Payment history accounts for 35% of a FICO score, making it the single most important factor. This reflects whether you've paid past credit accounts on time. Credit utilization is the second-largest component at 30%, not 35%. The model prioritizes demonstrated payment behavior over other factors.",
                                "difficulty": "medium"
                },
                {
                                "id": 5,
                                "question": "What role do credit bureaus play in credit scoring?",
                                "options": {
                                                "A": "They make loan approval decisions for lenders",
                                                "B": "They collect, maintain, and provide credit history data to lenders",
                                                "C": "They set interest rates based on borrower risk",
                                                "D": "They guarantee loan repayments for approved borrowers"
                                },
                                "correct": "B",
                                "explanation": "Credit bureaus (like Equifax, Experian, TransUnion) are information intermediaries. They collect credit data from various sources, maintain credit files, and provide this information to lenders who then make their own decisions. Bureaus don't approve loans, set rates, or guarantee repayments - they provide data infrastructure.",
                                "difficulty": "easy"
                },
                {
                                "id": 6,
                                "question": "Why is logistic regression commonly used in credit scoring models?",
                                "options": {
                                                "A": "It produces the highest possible accuracy compared to all other methods",
                                                "B": "It outputs probabilities and is interpretable, which helps with regulatory compliance",
                                                "C": "It requires no data preprocessing or feature scaling",
                                                "D": "It automatically removes bias from the training data"
                                },
                                "correct": "B",
                                "explanation": "Logistic regression is favored in credit scoring because it outputs interpretable probabilities and allows examination of feature coefficients - crucial for explaining decisions to regulators and consumers. While deep learning might achieve higher accuracy, explainability is legally required in many jurisdictions. Logistic regression does require preprocessing and doesn't automatically eliminate bias.",
                                "difficulty": "medium"
                },
                {
                                "id": 7,
                                "question": "In a credit scoring model, if a feature has a coefficient of +0.8, what does this indicate?",
                                "options": {
                                                "A": "Higher values of this feature decrease default risk",
                                                "B": "This feature has 80% correlation with default",
                                                "C": "Higher values of this feature increase default risk",
                                                "D": "This feature explains 80% of model variance"
                                },
                                "correct": "C",
                                "explanation": "In logistic regression, positive coefficients indicate that higher feature values increase the probability of the positive class (default). For example, higher debt-to-income ratios increase default risk, so this feature would have a positive coefficient. Negative coefficients decrease risk. The magnitude reflects impact strength, not correlation or variance explained.",
                                "difficulty": "medium"
                },
                {
                                "id": 8,
                                "question": "How are scorecard points typically calculated in traditional credit scoring?",
                                "options": {
                                                "A": "By multiplying feature values by their coefficients and scaling to a point system",
                                                "B": "By counting the number of positive features and subtracting negative ones",
                                                "C": "By averaging all feature values into a single number",
                                                "D": "By ranking borrowers against each other in the database"
                                },
                                "correct": "A",
                                "explanation": "Scorecard points are derived from logistic regression coefficients. Each feature's value is multiplied by its coefficient, these are summed, and the result is scaled to a desired point range (e.g., 300-850 for FICO). This maintains the mathematical relationship from the model while presenting scores in an intuitive format. Simple averaging or counting would lose the predictive weighting.",
                                "difficulty": "medium"
                },
                {
                                "id": 9,
                                "question": "What does the AUC (Area Under the ROC Curve) metric measure in credit scoring?",
                                "options": {
                                                "A": "The percentage of borrowers correctly classified as defaulters or non-defaulters",
                                                "B": "The model's ability to rank defaulters higher risk than non-defaulters across all thresholds",
                                                "C": "The average dollar amount correctly predicted for loan defaults",
                                                "D": "The correlation between predicted and actual default rates"
                                },
                                "correct": "B",
                                "explanation": "AUC measures discrimination - the model's ability to rank-order risk correctly. An AUC of 0.80 means that if you randomly pick one defaulter and one non-defaulter, the model will correctly assign higher risk to the defaulter 80% of the time. This is threshold-independent, unlike accuracy which depends on a specific cutoff. AUC ranges from 0.5 (random) to 1.0 (perfect).",
                                "difficulty": "hard"
                },
                {
                                "id": 10,
                                "question": "What does the Gini coefficient measure in the context of credit scoring model performance?",
                                "options": {
                                                "A": "Income inequality among borrowers in the dataset",
                                                "B": "Model discrimination, calculated as 2×AUC - 1",
                                                "C": "The proportion of defaults correctly identified",
                                                "D": "The fairness of the model across demographic groups"
                                },
                                "correct": "B",
                                "explanation": "In credit scoring, the Gini coefficient measures model discrimination power and is calculated as 2×AUC - 1. If AUC is 0.80, Gini is 0.60. Higher Gini (closer to 1) indicates better separation between defaulters and non-defaulters. While Gini measures economic inequality in other contexts, in credit modeling it's purely a performance metric, not a fairness measure.",
                                "difficulty": "hard"
                },
                {
                                "id": 11,
                                "question": "What is model calibration in credit scoring?",
                                "options": {
                                                "A": "Adjusting the model to give equal approval rates across all demographic groups",
                                                "B": "Ensuring predicted probabilities match actual default rates across risk bands",
                                                "C": "Tuning model parameters to maximize AUC score",
                                                "D": "Removing biased features from the training data"
                                },
                                "correct": "B",
                                "explanation": "Calibration means the model's predicted probabilities are accurate estimates of true probabilities. If the model predicts 20% default risk for 1000 borrowers, approximately 200 should actually default. A model can discriminate well (high AUC) but be poorly calibrated. Calibration is crucial for pricing loans and setting reserves, while discrimination matters for ranking decisions.",
                                "difficulty": "hard"
                },
                {
                                "id": 12,
                                "question": "Which of the following is an example of alternative data in credit scoring?",
                                "options": {
                                                "A": "Number of credit cards held by the applicant",
                                                "B": "Utility bill payment consistency",
                                                "C": "Employment length at current job",
                                                "D": "Previous mortgage payment history"
                                },
                                "correct": "B",
                                "explanation": "Alternative data refers to non-traditional sources not found in credit bureau reports. Utility payments, rent payments, mobile phone bills, and online shopping patterns are alternative data. Credit cards, employment history, and mortgage records are traditional credit data already captured by bureaus. Alternative data helps score 'thin-file' borrowers with limited credit history.",
                                "difficulty": "easy"
                },
                {
                                "id": 13,
                                "question": "What distinguishes 'thin-file' borrowers from 'thick-file' borrowers?",
                                "options": {
                                                "A": "Thin-file borrowers have lower incomes than thick-file borrowers",
                                                "B": "Thin-file borrowers have limited or no traditional credit history",
                                                "C": "Thin-file borrowers have defaulted on loans in the past",
                                                "D": "Thin-file borrowers live in rural rather than urban areas"
                                },
                                "correct": "B",
                                "explanation": "Thin-file borrowers have insufficient traditional credit history to generate a conventional credit score - they may be young, immigrants, or simply cash users. Thick-file borrowers have extensive credit histories. Thin-file status says nothing about income, default history, or location. Alternative data can be particularly valuable for scoring thin-file applicants who may be creditworthy but invisible to traditional models.",
                                "difficulty": "medium"
                },
                {
                                "id": 14,
                                "question": "What is the reject inference problem in credit scoring?",
                                "options": {
                                                "A": "Customers refusing to provide alternative data due to privacy concerns",
                                                "B": "Models being unable to learn from rejected applicants whose true risk is unknown",
                                                "C": "Regulators rejecting models that show demographic disparities",
                                                "D": "Borrowers rejecting loan offers due to high interest rates"
                                },
                                "correct": "B",
                                "explanation": "Reject inference addresses the problem that training data only includes approved borrowers - we observe defaults only for loans we made. Rejected applicants' true default risk is unknown, creating selection bias. If we only approve low-risk applicants, the model may underestimate overall risk. Various techniques attempt to infer what would have happened to rejected applicants, but this remains a fundamental challenge.",
                                "difficulty": "hard"
                },
                {
                                "id": 15,
                                "question": "What is the difference between 'through-the-door' and 'clean-sample' model development?",
                                "options": {
                                                "A": "Through-the-door uses all applicants; clean-sample excludes rejected applicants",
                                                "B": "Through-the-door is for online applications; clean-sample is for in-branch",
                                                "C": "Through-the-door includes alternative data; clean-sample uses only traditional data",
                                                "D": "Through-the-door is for new customers; clean-sample is for existing customers"
                                },
                                "correct": "A",
                                "explanation": "Through-the-door development uses all applicants (attempting to handle reject inference), while clean-sample uses only approved applicants with observed outcomes. Clean-sample is simpler but suffers from selection bias. Through-the-door attempts to be more representative but requires assumptions about rejected applicants. Both approaches have trade-offs between bias and complexity.",
                                "difficulty": "hard"
                },
                {
                                "id": 16,
                                "question": "What are adverse action notices in the context of credit decisions?",
                                "options": {
                                                "A": "Warnings sent to borrowers who are late on payments",
                                                "B": "Required explanations to applicants about why they were denied credit",
                                                "C": "Alerts to lenders when borrowers apply for multiple loans",
                                                "D": "Notifications to credit bureaus about fraudulent applications"
                                },
                                "correct": "B",
                                "explanation": "Under laws like ECOA and FCRA, lenders must provide adverse action notices explaining why credit was denied, offering less favorable terms, or why an existing account was closed. These must cite specific reasons (e.g., 'high debt-to-income ratio') rather than just a credit score. This requirement drives demand for interpretable models and creates legal risk for 'black box' AI systems.",
                                "difficulty": "medium"
                },
                {
                                "id": 17,
                                "question": "What is disparate impact in lending?",
                                "options": {
                                                "A": "Intentionally charging different interest rates to different demographic groups",
                                                "B": "Lending policies that appear neutral but disproportionately harm protected groups",
                                                "C": "Using protected characteristics like race or gender as model features",
                                                "D": "Approving loans at different times of day based on when applications arrive"
                                },
                                "correct": "B",
                                "explanation": "Disparate impact (or adverse impact) occurs when facially neutral policies disproportionately exclude protected groups, even without discriminatory intent. For example, requiring high credit scores may disproportionately exclude minorities due to historical inequality. This is illegal under fair lending laws unless the policy is justified by business necessity. The 'four-fifths rule' (80% threshold) is a common test for disparate impact.",
                                "difficulty": "medium"
                },
                {
                                "id": 18,
                                "question": "Which U.S. law prohibits discrimination in lending based on race, color, religion, national origin, sex, marital status, or age?",
                                "options": {
                                                "A": "Fair Credit Reporting Act (FCRA)",
                                                "B": "Equal Credit Opportunity Act (ECOA)",
                                                "C": "Gramm-Leach-Bliley Act (GLBA)",
                                                "D": "Community Reinvestment Act (CRA)"
                                },
                                "correct": "B",
                                "explanation": "The Equal Credit Opportunity Act (ECOA, 1974) prohibits credit discrimination based on protected characteristics. FCRA regulates credit reporting accuracy and access. GLBA governs financial privacy. CRA encourages lending in underserved communities. ECOA is the primary anti-discrimination law, enforced by agencies like CFPB, and applies to all credit decisions - applications, pricing, and servicing.",
                                "difficulty": "medium"
                },
                {
                                "id": 19,
                                "question": "Why do regulations increasingly require credit scoring models to be explainable?",
                                "options": {
                                                "A": "To enable lenders to manually override incorrect model predictions",
                                                "B": "To allow applicants to understand and dispute decisions, and ensure compliance with anti-discrimination laws",
                                                "C": "To make it easier for competitors to copy successful models",
                                                "D": "To reduce the computational cost of running complex models"
                                },
                                "correct": "B",
                                "explanation": "Explainability serves multiple regulatory purposes: it enables adverse action notices (required by law), allows borrowers to understand and contest decisions, helps regulators audit for discrimination, and enables lenders to demonstrate compliance with fair lending laws. Complex 'black box' models create legal risk even if accurate. The EU's AI Act and 'right to explanation' requirements further emphasize transparency over pure performance.",
                                "difficulty": "medium"
                },
                {
                                "id": 20,
                                "question": "How do Buy Now Pay Later (BNPL) services differ from traditional credit scoring?",
                                "options": {
                                                "A": "BNPL services never check credit and approve all customers",
                                                "B": "BNPL services often use real-time alternative data for instant, soft-touch credit decisions",
                                                "C": "BNPL services only lend to customers with excellent credit scores",
                                                "D": "BNPL services are unregulated and exempt from fair lending laws"
                                },
                                "correct": "B",
                                "explanation": "BNPL services like Affirm and Klarna typically perform instant credit checks using alternative data (transaction history, device data, shopping patterns) rather than traditional hard credit pulls. They make real-time decisions at checkout, often with minimal friction. However, they're increasingly subject to credit regulations - they're not exempt from consumer protection laws, and regulators are expanding oversight as BNPL grows.",
                                "difficulty": "hard"
                }
]
        };

        const state = {
            currentIndex: 0,
            answers: {},
            score: 0,
            displayedQuestions: [],
            pendingSlots: []
        };

        const questionsRow = document.getElementById('questionsRow');
        const progressBar = document.getElementById('progressBar');
        const progressBadge = document.getElementById('progressBadge');
        const scoreBadge = document.getElementById('scoreBadge');
        const resultsCard = document.getElementById('resultsCard');
        const nextBtn = document.getElementById('nextBtn');

        function initQuiz() {
            state.currentIndex = 0;
            state.answers = {};
            state.score = 0;
            state.displayedQuestions = [];
            state.pendingSlots = [];

            resultsCard.classList.remove('show');
            questionsRow.style.display = 'grid';
            nextBtn.classList.remove('show');

            // Show first 3 questions
            for (let i = 0; i < 3 && i < quizData.questions.length; i++) {
                state.displayedQuestions.push(i);
            }
            state.currentIndex = Math.min(3, quizData.questions.length);

            renderQuestions();
            updateStats();
        }

        function renderQuestions() {
            questionsRow.innerHTML = '';

            state.displayedQuestions.forEach((qIdx, slot) => {
                const q = quizData.questions[qIdx];
                const answered = state.answers[q.id] !== undefined;
                const isCorrect = answered && state.answers[q.id] === q.correct;
                const isIncorrect = answered && state.answers[q.id] !== q.correct;

                const card = document.createElement('div');
                card.className = 'question-card';
                if (isCorrect) card.classList.add('correct-card', 'answered');
                if (isIncorrect) card.classList.add('incorrect-card', 'answered');

                card.innerHTML = `
                    <div class="q-header">
                        <span class="q-number">Q${qIdx + 1}</span>
                        ${answered ? `<span class="q-status">${isCorrect ? '&#10004;' : '&#10008;'}</span>` : ''}
                    </div>
                    <div class="q-text">${q.question}</div>
                    <div class="options" data-qid="${q.id}" data-slot="${slot}">
                        ${['A','B','C','D'].map(letter => {
                            let optClass = 'option-btn';
                            if (answered) {
                                optClass += ' disabled';
                                if (letter === q.correct) optClass += ' correct';
                                else if (letter === state.answers[q.id]) optClass += ' incorrect';
                            }
                            return `
                                <button class="${optClass}" data-letter="${letter}" ${answered ? 'disabled' : ''}>
                                    <span class="option-letter">${letter}</span>
                                    <span class="option-text">${q.options[letter]}</span>
                                </button>
                            `;
                        }).join('')}
                    </div>
                    <div class="feedback ${answered ? 'show' : ''} ${isCorrect ? 'correct' : 'incorrect'}">
                        ${answered ? (isCorrect ? '&#10004; ' : `&#10008; Answer: ${q.correct}. `) + q.explanation : ''}
                    </div>
                `;

                // Add click handlers
                if (!answered) {
                    card.querySelectorAll('.option-btn').forEach(btn => {
                        btn.addEventListener('click', () => handleAnswer(qIdx, slot, btn.dataset.letter));
                    });
                }

                questionsRow.appendChild(card);
            });

            renderMath();
        }

        function handleAnswer(qIdx, slot, letter) {
            const q = quizData.questions[qIdx];
            state.answers[q.id] = letter;

            if (letter === q.correct) state.score++;

            // Track this slot as pending replacement
            if (!state.pendingSlots.includes(slot)) {
                state.pendingSlots.push(slot);
            }

            updateStats();
            renderQuestions();

            // Check if all questions answered
            const answered = Object.keys(state.answers).length;
            if (answered >= quizData.questions.length) {
                // Short delay then show results
                setTimeout(showResults, 800);
            } else if (state.currentIndex < quizData.questions.length && state.pendingSlots.length > 0) {
                // Show Next button if there are more questions and pending slots
                nextBtn.classList.add('show');
            }
        }

        function loadNextQuestions() {
            // Replace pending slots with new questions
            while (state.pendingSlots.length > 0 && state.currentIndex < quizData.questions.length) {
                const slot = state.pendingSlots.shift();
                state.displayedQuestions[slot] = state.currentIndex;
                state.currentIndex++;
            }

            // Hide Next button
            nextBtn.classList.remove('show');

            renderQuestions();

            // Check if quiz is complete (all displayed questions answered)
            const answered = Object.keys(state.answers).length;
            if (answered >= quizData.questions.length) {
                setTimeout(showResults, 500);
            }
        }

        function updateStats() {
            const answered = Object.keys(state.answers).length;
            const total = quizData.questions.length;

            progressBar.style.width = `${(answered / total) * 100}%`;
            progressBadge.textContent = `${answered}/${total}`;
            scoreBadge.textContent = `Score: ${state.score}`;
        }

        function showResults() {
            questionsRow.style.display = 'none';
            nextBtn.classList.remove('show');
            resultsCard.classList.add('show');

            const total = quizData.questions.length;
            const percentage = Math.round((state.score / total) * 100);

            document.getElementById('resultsScore').textContent = `${state.score}/${total}`;

            let grade, gradeClass, icon;
            if (percentage >= 90) { grade = 'Excellent! A'; gradeClass = 'grade-a'; icon = '&#127942;'; }
            else if (percentage >= 80) { grade = 'Great! B'; gradeClass = 'grade-b'; icon = '&#11088;'; }
            else if (percentage >= 70) { grade = 'Good! C'; gradeClass = 'grade-c'; icon = '&#128077;'; }
            else if (percentage >= 60) { grade = 'Pass - D'; gradeClass = 'grade-d'; icon = '&#128221;'; }
            else { grade = 'Keep practicing'; gradeClass = 'grade-f'; icon = '&#128218;'; }

            document.getElementById('resultsIcon').innerHTML = icon;
            const gradeEl = document.getElementById('resultsGrade');
            gradeEl.textContent = `${grade} (${percentage}%)`;
            gradeEl.className = `results-grade ${gradeClass}`;
        }

        function restartQuiz() {
            initQuiz();
        }

        function renderMath() {
            if (typeof renderMathInElement !== 'undefined') {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initQuiz();
            setTimeout(renderMath, 100);
        });
    </script>
</body>
</html>
