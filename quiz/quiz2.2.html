<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz 2.2: Api Economy Baas | Introduction to Digital Finance</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
        :root {
            --mlpurple: #3333B2;
            --mlblue: #0066CC;
            --quiz-accent: #8b5cf6;
            --quiz-light: #ede9fe;
            --correct: #22c55e;
            --correct-bg: #dcfce7;
            --incorrect: #ef4444;
            --incorrect-bg: #fee2e2;
            --bg: #f6f8fa;
            --card-bg: #ffffff;
            --text: #24292e;
            --text-secondary: #586069;
            --border: #e1e4e8;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.4;
            min-height: 100vh;
        }

        .nav {
            background: linear-gradient(135deg, var(--mlpurple), var(--mlblue));
            color: white;
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-title { font-weight: 600; font-size: 14px; }
        .nav-links { display: flex; gap: 16px; }
        .nav-links a { color: white; text-decoration: none; font-size: 12px; opacity: 0.9; }
        .nav-links a:hover { opacity: 1; }

        .quiz-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 12px;
        }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 0 4px;
        }
        .quiz-title { font-size: 16px; font-weight: 600; color: var(--mlpurple); }
        .quiz-stats {
            display: flex;
            gap: 12px;
            font-size: 12px;
        }
        .stat-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
        }
        .stat-progress { background: var(--quiz-light); color: var(--quiz-accent); }
        .stat-score { background: var(--correct-bg); color: var(--correct); }

        .progress-bar-container {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin-bottom: 12px;
        }
        .progress-bar {
            height: 100%;
            background: var(--quiz-accent);
            border-radius: 2px;
            transition: width 0.3s;
        }

        /* Three-column layout */
        .questions-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .question-card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 12px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            min-height: 280px;
        }

        .question-card.answered { opacity: 0.7; }

        .question-card.correct-card {
            border: 2px solid var(--correct);
            background: linear-gradient(to bottom, var(--correct-bg), var(--card-bg));
        }

        .question-card.incorrect-card {
            border: 2px solid var(--incorrect);
            background: linear-gradient(to bottom, var(--incorrect-bg), var(--card-bg));
        }

        .q-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .q-number {
            background: var(--quiz-light);
            color: var(--quiz-accent);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        .q-status { font-size: 14px; }

        .q-text {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 10px;
            line-height: 1.4;
            flex-grow: 0;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex-grow: 1;
        }

        .option-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            min-height: 44px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--card-bg);
            cursor: pointer;
            transition: all 0.15s;
            text-align: left;
            font-size: 12px;
        }

        .option-btn:hover:not(.disabled) {
            border-color: var(--quiz-accent);
            background: var(--quiz-light);
        }

        .option-btn.correct {
            border-color: var(--correct);
            background: var(--correct-bg);
        }

        .option-btn.incorrect {
            border-color: var(--incorrect);
            background: var(--incorrect-bg);
        }

        .option-btn.disabled { cursor: default; }

        .option-letter {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 10px;
            flex-shrink: 0;
        }

        .option-btn.correct .option-letter {
            background: var(--correct);
            color: white;
        }

        .option-btn.incorrect .option-letter {
            background: var(--incorrect);
            color: white;
        }

        .option-text { flex: 1; }

        .feedback {
            margin-top: 8px;
            padding: 8px;
            border-radius: 6px;
            font-size: 10px;
            line-height: 1.4;
            display: none;
        }

        .feedback.show { display: block; }
        .feedback.correct { background: var(--correct-bg); color: #166534; }
        .feedback.incorrect { background: var(--incorrect-bg); color: #991b1b; }

        /* Results */
        .results-card {
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 32px;
            text-align: center;
            max-width: 500px;
            margin: 40px auto;
            display: none;
        }
        .results-card.show { display: block; }
        .results-icon { font-size: 48px; margin-bottom: 8px; }
        .results-score { font-size: 36px; font-weight: 700; color: var(--quiz-accent); }
        .results-label { font-size: 14px; color: var(--text-secondary); margin-bottom: 16px; }
        .results-grade {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        .grade-a { background: #dcfce7; color: #166534; }
        .grade-b { background: #dbeafe; color: #1e40af; }
        .grade-c { background: #fef3c7; color: #92400e; }
        .grade-d { background: #fed7aa; color: #9a3412; }
        .grade-f { background: #fee2e2; color: #991b1b; }

        .results-buttons { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            text-decoration: none;
        }
        .btn-primary { background: var(--quiz-accent); color: white; }
        .btn-primary:hover { background: #7c3aed; }
        .btn-secondary { background: var(--card-bg); color: var(--text); border: 1px solid var(--border); }

        /* Next button container */
        .next-btn-container {
            display: flex;
            justify-content: center;
            margin-top: 16px;
        }
        .btn-next {
            padding: 10px 32px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            background: var(--quiz-accent);
            color: white;
            transition: all 0.2s;
            display: none;
        }
        .btn-next:hover { background: #7c3aed; transform: scale(1.02); }
        .btn-next.show { display: inline-block; }
        .btn-next:disabled { opacity: 0.5; cursor: not-allowed; }

        @media (max-width: 900px) {
            .questions-row { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 600px) {
            .questions-row { grid-template-columns: 1fr; }
            .question-card { min-height: auto; }
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-title">Quiz 2.2: Api Economy Baas</div>
        <div class="nav-links">
            <a href="../index.html">Dashboard</a>
            
            <a href="https://github.com/Digital-AI-Finance/Digital-Finance-Introduction" target="_blank">GitHub</a>
        </div>
    </nav>

    <main class="quiz-container">
        <div class="quiz-header">
            <div class="quiz-title">Quiz 2.2: Api Economy Baas</div>
            <div class="quiz-stats">
                <span class="stat-badge stat-progress" id="progressBadge">0/20</span>
                <span class="stat-badge stat-score" id="scoreBadge">Score: 0</span>
            </div>
        </div>

        <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>

        <div class="questions-row" id="questionsRow"></div>

        <div class="next-btn-container">
            <button class="btn-next" id="nextBtn" onclick="loadNextQuestions()">Next</button>
        </div>

        <div class="results-card" id="resultsCard">
            <div class="results-icon" id="resultsIcon"></div>
            <div class="results-score" id="resultsScore"></div>
            <div class="results-label">Correct Answers</div>
            <div class="results-grade" id="resultsGrade"></div>
            <div class="results-buttons">
                <button class="btn btn-primary" onclick="restartQuiz()">Try Again</button>
                <a href="../index.html" class="btn btn-secondary">Dashboard</a>
            </div>
        </div>
    </main>

    <script>
        const quizData = {
            questions: [
                {
                                "id": 1,
                                "question": "What is Open Banking?",
                                "options": {
                                                "A": "A system where banks provide free checking accounts",
                                                "B": "A framework allowing third-party providers to access consumer banking data through secure APIs with consent",
                                                "C": "An open-source banking software platform",
                                                "D": "A public database of all banking transactions"
                                },
                                "correct": "B",
                                "explanation": "Open Banking is a regulatory and technological framework that allows third-party financial service providers to access consumer banking data through secure APIs, with the consumer's consent. It is mandated by regulations like PSD2 in Europe.",
                                "difficulty": "easy"
                },
                {
                                "id": 2,
                                "question": "What is the primary purpose of the PSD2 (Payment Services Directive 2) regulation?",
                                "options": {
                                                "A": "To protect banks from cyber attacks",
                                                "B": "To mandate that banks open their APIs to third-party providers",
                                                "C": "To eliminate all banking fees in Europe",
                                                "D": "To create a single European currency"
                                },
                                "correct": "B",
                                "explanation": "PSD2 is an EU regulation enacted in 2018 that mandates banks to open their APIs to licensed third-party providers. This creates a more competitive and innovative financial services market while maintaining security and consumer protection.",
                                "difficulty": "easy"
                },
                {
                                "id": 3,
                                "question": "What does AISP stand for and what is its role in Open Banking?",
                                "options": {
                                                "A": "Automated Information Security Protocol - manages encryption",
                                                "B": "Account Information Service Provider - reads account data and provides insights",
                                                "C": "Advanced Investment Strategy Platform - manages portfolios",
                                                "D": "API Integration Service Provider - maintains bank servers"
                                },
                                "correct": "B",
                                "explanation": "AISP stands for Account Information Service Provider. These are third parties that can read account data with user consent. They provide services like account aggregation, budgeting apps, and financial insights without being able to move money.",
                                "difficulty": "easy"
                },
                {
                                "id": 4,
                                "question": "What is the role of a PISP (Payment Initiation Service Provider)?",
                                "options": {
                                                "A": "To store customer payment credentials",
                                                "B": "To initiate payments directly from customer bank accounts with consent",
                                                "C": "To provide insurance for payment transactions",
                                                "D": "To process credit card transactions only"
                                },
                                "correct": "B",
                                "explanation": "A PISP can initiate payments on behalf of users directly from their bank accounts, with proper consent. This enables services like direct bank-to-bank payments without card networks, potentially reducing transaction fees and enabling new payment experiences.",
                                "difficulty": "easy"
                },
                {
                                "id": 5,
                                "question": "In the OAuth 2.0 Authorization Code flow used in Open Banking, what is the correct sequence of steps?",
                                "options": {
                                                "A": "User grants consent → Authorization code issued → Code exchanged for access token → API access with token",
                                                "B": "Access token requested → User grants consent → Authorization code issued → API access",
                                                "C": "API access attempted → User grants consent → Access token issued directly",
                                                "D": "User grants consent → Access token issued directly → API access"
                                },
                                "correct": "A",
                                "explanation": "The OAuth 2.0 flow follows a secure sequence: (1) User is redirected to bank and grants consent, (2) Bank issues a short-lived authorization code, (3) TPP exchanges code for access token server-to-server, (4) TPP uses access token to call APIs. This multi-step process ensures security.",
                                "difficulty": "medium"
                },
                {
                                "id": 6,
                                "question": "What is the primary difference between an access token and a refresh token in Open Banking?",
                                "options": {
                                                "A": "Access tokens are used for payments, refresh tokens for account information",
                                                "B": "Access tokens are short-lived for API calls, refresh tokens are long-lived to obtain new access tokens",
                                                "C": "Access tokens are public, refresh tokens are private",
                                                "D": "Access tokens work with all banks, refresh tokens are bank-specific"
                                },
                                "correct": "B",
                                "explanation": "Access tokens are short-lived (typically 1 hour) bearer tokens used to authenticate API requests. Refresh tokens are longer-lived tokens that can be used to obtain new access tokens without requiring the user to re-authenticate, improving user experience while maintaining security.",
                                "difficulty": "medium"
                },
                {
                                "id": 7,
                                "question": "What is Strong Customer Authentication (SCA) and when is it required under PSD2?",
                                "options": {
                                                "A": "A credit check performed on all new customers",
                                                "B": "Multi-factor authentication required for payment initiation and consent granting",
                                                "C": "A government-issued ID verification process",
                                                "D": "A password strength requirement of at least 12 characters"
                                },
                                "correct": "B",
                                "explanation": "Strong Customer Authentication (SCA) requires at least two of three authentication factors: something you know (password), something you have (mobile device), and something you are (biometric). It's mandatory for payment initiation and when granting initial consent to protect against fraud.",
                                "difficulty": "medium"
                },
                {
                                "id": 8,
                                "question": "What is the purpose of API rate limiting in Open Banking?",
                                "options": {
                                                "A": "To charge TPPs more money for higher usage",
                                                "B": "To prevent abuse, ensure fair resource allocation, and protect bank infrastructure",
                                                "C": "To slow down competitors' applications",
                                                "D": "To encourage customers to use the bank's own app"
                                },
                                "correct": "B",
                                "explanation": "API rate limiting restricts the number of API calls a TPP can make in a given time period. This prevents abuse (like DoS attacks), ensures fair resource allocation among TPPs, protects bank infrastructure from overload, and ensures quality of service for all users.",
                                "difficulty": "medium"
                },
                {
                                "id": 9,
                                "question": "What is a key benefit of account aggregation services enabled by Open Banking?",
                                "options": {
                                                "A": "Banks can see all transactions across their competitors",
                                                "B": "Users can view and manage all their accounts across multiple banks in one place",
                                                "C": "Governments can monitor all citizen transactions automatically",
                                                "D": "Banks no longer need to maintain their own mobile apps"
                                },
                                "correct": "B",
                                "explanation": "Account aggregation allows users to connect multiple bank accounts from different banks to a single app (like Mint or Plaid). This provides a unified view of finances, better budgeting capabilities, net worth tracking, and comprehensive cash flow analysis without requiring screen scraping.",
                                "difficulty": "easy"
                },
                {
                                "id": 10,
                                "question": "What is consent management in the context of Open Banking?",
                                "options": {
                                                "A": "A legal process for banks to merge with competitors",
                                                "B": "The system allowing users to grant, view, and revoke third-party access to their banking data",
                                                "C": "A marketing tool to get customer agreement for promotions",
                                                "D": "An internal bank process for approving new accounts"
                                },
                                "correct": "B",
                                "explanation": "Consent management is the framework that gives users control over their data. Users must explicitly grant permission for TPPs to access specific data, can view all active consents showing what each TPP can access, and can revoke consent at any time. This is a fundamental principle of Open Banking.",
                                "difficulty": "medium"
                },
                {
                                "id": 11,
                                "question": "How does screen scraping differ from API access in Open Banking?",
                                "options": {
                                                "A": "Screen scraping is more secure than API access",
                                                "B": "Screen scraping requires storing user credentials and is fragile, while API access uses tokens and is standardized",
                                                "C": "Screen scraping is required by PSD2, API access is optional",
                                                "D": "Screen scraping only works with mobile apps, API access only with websites"
                                },
                                "correct": "B",
                                "explanation": "Screen scraping requires storing user bank passwords and programmatically logging into banking websites, which is insecure and breaks when websites change. API access uses secure tokens, doesn't require password storage, has standardized formats, and is officially supported by banks. Open Banking makes screen scraping obsolete.",
                                "difficulty": "medium"
                },
                {
                                "id": 12,
                                "question": "What are the main components of the Open Banking security model?",
                                "options": {
                                                "A": "Username and password only",
                                                "B": "OAuth 2.0, Strong Customer Authentication (SCA), API tokens with limited scope and expiration",
                                                "C": "Blockchain verification and cryptocurrency payments",
                                                "D": "Physical security tokens mailed to customers"
                                },
                                "correct": "B",
                                "explanation": "The Open Banking security model combines multiple layers: OAuth 2.0 for authorization, Strong Customer Authentication (SCA) for user verification, short-lived access tokens with limited scope, refresh tokens for seamless renewal, and regulatory oversight of TPPs. This provides strong security while enabling innovation.",
                                "difficulty": "hard"
                },
                {
                                "id": 13,
                                "question": "What are the typical requirements for TPP (Third Party Provider) registration?",
                                "options": {
                                                "A": "Only a valid email address and business name",
                                                "B": "Regulatory authorization, registration with competent authority, assigned TPP ID, and compliance with standards",
                                                "C": "Proof of insurance and a bank account",
                                                "D": "A certain number of existing customers"
                                },
                                "correct": "B",
                                "explanation": "TPPs must be authorized by financial regulators (like FCA in UK, BaFin in Germany), obtain official registration with a competent authority, receive a unique TPP ID, comply with data protection laws (GDPR), and meet technical standards. This ensures only legitimate, secure providers access banking data.",
                                "difficulty": "hard"
                },
                {
                                "id": 14,
                                "question": "What does XS2A stand for and what is its significance in Open Banking?",
                                "options": {
                                                "A": "Extra Secure Authentication - a new 2FA method",
                                                "B": "Access to Account - the framework defining how third parties access account information",
                                                "C": "Cross-System API - a protocol for international transfers",
                                                "D": "Extended Security for Applications - a certification standard"
                                },
                                "correct": "B",
                                "explanation": "XS2A stands for 'Access to Account' and represents the technical framework and standards that define how third-party providers can access bank account information under PSD2. It covers API specifications, security requirements, and data formats, particularly in the Berlin Group standards.",
                                "difficulty": "hard"
                },
                {
                                "id": 15,
                                "question": "Which of the following is a primary use case for Open Banking?",
                                "options": {
                                                "A": "Creating cryptocurrency exchanges",
                                                "B": "Personal finance management apps that aggregate accounts and categorize spending",
                                                "C": "Replacing all bank branches with online-only services",
                                                "D": "Eliminating the need for credit cards"
                                },
                                "correct": "B",
                                "explanation": "Personal finance management (PFM) apps like Mint, YNAB, or Emma are classic Open Banking use cases. They aggregate accounts from multiple banks, categorize transactions, provide budgeting tools, and offer financial insights. Other use cases include comparison services, lending platforms, and payment initiation services.",
                                "difficulty": "easy"
                },
                {
                                "id": 16,
                                "question": "What is the principle of data minimization in Open Banking?",
                                "options": {
                                                "A": "Banks should store as little data as possible",
                                                "B": "TPPs should only request and access the minimum data necessary for their service",
                                                "C": "Transactions should be recorded with minimal details",
                                                "D": "API responses should be compressed to save bandwidth"
                                },
                                "correct": "B",
                                "explanation": "Data minimization is a GDPR and Open Banking principle stating that TPPs should only request and access the minimum data necessary to provide their specific service. For example, a budgeting app only needs transaction history, not payment initiation rights. This protects user privacy and limits risk.",
                                "difficulty": "medium"
                },
                {
                                "id": 17,
                                "question": "What is a regulatory sandbox in the context of Open Banking?",
                                "options": {
                                                "A": "A secure testing environment where fintech companies can test innovations under regulatory supervision with reduced compliance burden",
                                                "B": "A physical location where regulators work",
                                                "C": "A type of security certificate for APIs",
                                                "D": "A database for storing customer complaints"
                                },
                                "correct": "A",
                                "explanation": "A regulatory sandbox is a framework allowing fintech companies to test innovative products, services, or business models in a live environment under regulatory supervision. It provides temporary relaxation of some regulations while maintaining consumer protection, enabling innovation without full compliance costs initially.",
                                "difficulty": "hard"
                },
                {
                                "id": 18,
                                "question": "How does Open Finance differ from Open Banking?",
                                "options": {
                                                "A": "Open Finance only applies to investment accounts",
                                                "B": "Open Finance extends beyond banking to include pensions, investments, insurance, and other financial products",
                                                "C": "Open Finance is the American term for Open Banking",
                                                "D": "Open Finance uses blockchain while Open Banking uses traditional databases"
                                },
                                "correct": "B",
                                "explanation": "Open Finance is the evolution of Open Banking that extends the concept beyond bank accounts to include pensions, investments, insurance, mortgages, and other financial products. It aims to give consumers comprehensive control over all their financial data across different types of financial services.",
                                "difficulty": "hard"
                },
                {
                                "id": 19,
                                "question": "What is the Berlin Group in the context of Open Banking standards?",
                                "options": {
                                                "A": "A German regulatory authority for financial services",
                                                "B": "A pan-European payment services organization that developed the NextGenPSD2 API framework",
                                                "C": "A group of Berlin-based fintech startups",
                                                "D": "The European Central Bank's innovation lab"
                                },
                                "correct": "B",
                                "explanation": "The Berlin Group is a pan-European payment services organization that developed the NextGenPSD2 Framework, which includes standardized API specifications for PSD2 compliance. Many European banks implement the Berlin Group standards, making it easier for TPPs to integrate with multiple banks using a consistent API.",
                                "difficulty": "hard"
                },
                {
                                "id": 20,
                                "question": "What is the current state of global Open Banking adoption?",
                                "options": {
                                                "A": "Only mandatory in the EU, not implemented elsewhere",
                                                "B": "Mandatory in EU/UK, with voluntary adoption in some countries; regulatory frameworks emerging in Asia, Americas, and Oceania",
                                                "C": "Fully implemented globally with identical standards everywhere",
                                                "D": "Still in proposal stage with no real implementations"
                                },
                                "correct": "B",
                                "explanation": "Open Banking is mandatory in the EU (PSD2) and UK (CMA Order). Other regions have varying approaches: Australia has Consumer Data Right (CDR), Brazil has Open Banking regulations, US has CFPB 1033 rule, and countries like Singapore, Japan, and India are developing frameworks. Standards and timelines vary by jurisdiction, but the trend is toward global adoption.",
                                "difficulty": "medium"
                }
]
        };

        const state = {
            currentIndex: 0,
            answers: {},
            score: 0,
            displayedQuestions: [],
            pendingSlots: []
        };

        const questionsRow = document.getElementById('questionsRow');
        const progressBar = document.getElementById('progressBar');
        const progressBadge = document.getElementById('progressBadge');
        const scoreBadge = document.getElementById('scoreBadge');
        const resultsCard = document.getElementById('resultsCard');
        const nextBtn = document.getElementById('nextBtn');

        function initQuiz() {
            state.currentIndex = 0;
            state.answers = {};
            state.score = 0;
            state.displayedQuestions = [];
            state.pendingSlots = [];

            resultsCard.classList.remove('show');
            questionsRow.style.display = 'grid';
            nextBtn.classList.remove('show');

            // Show first 3 questions
            for (let i = 0; i < 3 && i < quizData.questions.length; i++) {
                state.displayedQuestions.push(i);
            }
            state.currentIndex = Math.min(3, quizData.questions.length);

            renderQuestions();
            updateStats();
        }

        function renderQuestions() {
            questionsRow.innerHTML = '';

            state.displayedQuestions.forEach((qIdx, slot) => {
                const q = quizData.questions[qIdx];
                const answered = state.answers[q.id] !== undefined;
                const isCorrect = answered && state.answers[q.id] === q.correct;
                const isIncorrect = answered && state.answers[q.id] !== q.correct;

                const card = document.createElement('div');
                card.className = 'question-card';
                if (isCorrect) card.classList.add('correct-card', 'answered');
                if (isIncorrect) card.classList.add('incorrect-card', 'answered');

                card.innerHTML = `
                    <div class="q-header">
                        <span class="q-number">Q${qIdx + 1}</span>
                        ${answered ? `<span class="q-status">${isCorrect ? '&#10004;' : '&#10008;'}</span>` : ''}
                    </div>
                    <div class="q-text">${q.question}</div>
                    <div class="options" data-qid="${q.id}" data-slot="${slot}">
                        ${['A','B','C','D'].map(letter => {
                            let optClass = 'option-btn';
                            if (answered) {
                                optClass += ' disabled';
                                if (letter === q.correct) optClass += ' correct';
                                else if (letter === state.answers[q.id]) optClass += ' incorrect';
                            }
                            return `
                                <button class="${optClass}" data-letter="${letter}" ${answered ? 'disabled' : ''}>
                                    <span class="option-letter">${letter}</span>
                                    <span class="option-text">${q.options[letter]}</span>
                                </button>
                            `;
                        }).join('')}
                    </div>
                    <div class="feedback ${answered ? 'show' : ''} ${isCorrect ? 'correct' : 'incorrect'}">
                        ${answered ? (isCorrect ? '&#10004; ' : `&#10008; Answer: ${q.correct}. `) + q.explanation : ''}
                    </div>
                `;

                // Add click handlers
                if (!answered) {
                    card.querySelectorAll('.option-btn').forEach(btn => {
                        btn.addEventListener('click', () => handleAnswer(qIdx, slot, btn.dataset.letter));
                    });
                }

                questionsRow.appendChild(card);
            });

            renderMath();
        }

        function handleAnswer(qIdx, slot, letter) {
            const q = quizData.questions[qIdx];
            state.answers[q.id] = letter;

            if (letter === q.correct) state.score++;

            // Track this slot as pending replacement
            if (!state.pendingSlots.includes(slot)) {
                state.pendingSlots.push(slot);
            }

            updateStats();
            renderQuestions();

            // Check if all questions answered
            const answered = Object.keys(state.answers).length;
            if (answered >= quizData.questions.length) {
                // Short delay then show results
                setTimeout(showResults, 800);
            } else if (state.currentIndex < quizData.questions.length && state.pendingSlots.length > 0) {
                // Show Next button if there are more questions and pending slots
                nextBtn.classList.add('show');
            }
        }

        function loadNextQuestions() {
            // Replace pending slots with new questions
            while (state.pendingSlots.length > 0 && state.currentIndex < quizData.questions.length) {
                const slot = state.pendingSlots.shift();
                state.displayedQuestions[slot] = state.currentIndex;
                state.currentIndex++;
            }

            // Hide Next button
            nextBtn.classList.remove('show');

            renderQuestions();

            // Check if quiz is complete (all displayed questions answered)
            const answered = Object.keys(state.answers).length;
            if (answered >= quizData.questions.length) {
                setTimeout(showResults, 500);
            }
        }

        function updateStats() {
            const answered = Object.keys(state.answers).length;
            const total = quizData.questions.length;

            progressBar.style.width = `${(answered / total) * 100}%`;
            progressBadge.textContent = `${answered}/${total}`;
            scoreBadge.textContent = `Score: ${state.score}`;
        }

        function showResults() {
            questionsRow.style.display = 'none';
            nextBtn.classList.remove('show');
            resultsCard.classList.add('show');

            const total = quizData.questions.length;
            const percentage = Math.round((state.score / total) * 100);

            document.getElementById('resultsScore').textContent = `${state.score}/${total}`;

            let grade, gradeClass, icon;
            if (percentage >= 90) { grade = 'Excellent! A'; gradeClass = 'grade-a'; icon = '&#127942;'; }
            else if (percentage >= 80) { grade = 'Great! B'; gradeClass = 'grade-b'; icon = '&#11088;'; }
            else if (percentage >= 70) { grade = 'Good! C'; gradeClass = 'grade-c'; icon = '&#128077;'; }
            else if (percentage >= 60) { grade = 'Pass - D'; gradeClass = 'grade-d'; icon = '&#128221;'; }
            else { grade = 'Keep practicing'; gradeClass = 'grade-f'; icon = '&#128218;'; }

            document.getElementById('resultsIcon').innerHTML = icon;
            const gradeEl = document.getElementById('resultsGrade');
            gradeEl.textContent = `${grade} (${percentage}%)`;
            gradeEl.className = `results-grade ${gradeClass}`;
        }

        function restartQuiz() {
            initQuiz();
        }

        function renderMath() {
            if (typeof renderMathInElement !== 'undefined') {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initQuiz();
            setTimeout(renderMath, 100);
        });
    </script>
</body>
</html>
